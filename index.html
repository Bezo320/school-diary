<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>EDiary Ultimate v3</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --main: #f97316; --bg: #ffffff; --text: #1f2937; --card: #fef2f2; --border: #e5e7eb; }
    body.theme-blue { --main: #3b82f6; --card: #eff6ff; }
    body.theme-purple { --main: #8b5cf6; --card: #f5f3ff; }
    body.theme-pink { --main: #ec4899; --card: #fdf2f8; }
    body.theme-dark { --main: #6366f1; --bg: #111827; --text: #f9fafb; --card: #1f2937; --border: #374151; }

    body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; }
    header { background: var(--main); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border); }
    
    .nav-menu { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
    .nav-menu button { background: var(--border); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; color: var(--text); }
    .nav-menu button.active { background: var(--main); color: white; }

    input, select, button, textarea { padding: 12px; margin: 5px 0; width: 100%; border-radius: 8px; border: 1px solid var(--border); box-sizing: border-box; background: var(--bg); color: var(--text); }
    button.btn-main { background: var(--main); color: white; border: none; font-weight: bold; cursor: pointer; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
    .mark-badge { background: var(--main); color: white; padding: 3px 8px; border-radius: 4px; margin-right: 4px; font-weight: bold; }
    .hidden { display: none; }
    .flex { display: flex; gap: 10px; align-items: center; }
  </style>
</head>
<body class="theme-orange">

<header>
  <span id="userTitle">üìò –î–Ω–µ–≤–Ω–∏–∫</span>
  <select id="themePicker" onchange="changeTheme(this.value)" style="width: auto;">
    <option value="theme-orange">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
    <option value="theme-blue">–°–∏–Ω–∏–π</option>
    <option value="theme-purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
    <option value="theme-pink">–†–æ–∑–æ–≤—ã–π</option>
    <option value="theme-dark">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</option>
  </select>
</header>

<div class="container">
  <div id="authBlock" class="card">
    <h2>–í—Ö–æ–¥</h2>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <div class="flex">
      <select id="classNum">
        <option value="">–ö–ª–∞—Å—Å</option>
        <script>for(let i=1;i<=11;i++) document.write('<option value="'+i+'">'+i+'</option>')</script>
      </select>
      <select id="classLit">
        <option value="">–ë—É–∫–≤–∞</option>
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option><option value="–ì">–ì</option>
      </select>
    </div>
    <button class="btn-main" onclick="handleAuth()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>

  <div id="app" class="hidden">
    <div class="nav-menu" id="mainNav"></div>

    <div id="sec-schedule" class="section">
      <div class="card">
        <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏</h3>
        <div class="flex"><button onclick="changeWeek(-1)">‚¨ÖÔ∏è</button><button onclick="changeWeek(1)">‚û°Ô∏è</button></div>
        <div id="weekDates" style="text-align:center; padding:10px; font-weight:bold;"></div>
        <div id="scheduleList"></div>
      </div>
    </div>
<div id="sec-homework" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hwDatePicker" onchange="loadHomework()">
        <div id="hwResults"></div>
      </div>
    </div>

    <div id="sec-marks" class="section hidden">
      <div class="card">
        <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏ –∏ —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</h3>
        <table id="myMarksTable"></table>
      </div>
    </div>

    <div id="sec-teacher-marks" class="section hidden">
      <div class="card">
        <h3>–ñ—É—Ä–Ω–∞–ª: –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h3>
        <div class="flex">
          <input type="date" id="markDate">
          <select id="markSubject"></select>
        </div>
        <hr>
        <div id="studentsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>

    <div id="sec-teacher-hw" class="section hidden">
      <div class="card">
        <h3>–ó–∞–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hwActionDate">
        <select id="hwActionSubject"></select>
        <textarea id="hwText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∑–¥–µ—Å—å..."></textarea>
        <button class="btn-main" onclick="submitHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
      </div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let uData = null;
  let currentWeekOffset = 0;
  const subjects = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "–§–∏–∑–∏–∫–∞", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π"];

  function changeTheme(t) { document.body.className = t; localStorage.setItem('diary-theme', t); }

  function handleAuth() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    const r = document.getElementById('role').value;
    const c = document.getElementById('classNum').value + document.getElementById('classLit').value;
    if(!c  !email  !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

    auth.signInWithEmailAndPassword(email, pass).then(res => {
        db.ref('users/' + res.user.uid).update({ role: r, class: c, email: email });
    }).catch(() => {
        auth.createUserWithEmailAndPassword(email, pass).then(res => {
            db.ref('users/' + res.user.uid).set({ role: r, class: c, email: email });
        });
    });
  }

  auth.onAuthStateChanged(user => {
    if(user) {
      db.ref('users/' + user.uid).once('value', snap => {
        uData = snap.val(); uData.uid = user.uid;
        document.getElementById('authBlock').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userTitle').textContent = uData.email + " [" + uData.class + "]";
        initApp();
      });
    }
  });

  function logout() { auth.signOut().then(() => { location.reload(); }); }

  function initApp() {
    const nav = document.getElementById('mainNav');
    const subOpts = subjects.map(s => '<option value="'+s+'">'+s+'</option>').join('');
    document.getElementById('markSubject').innerHTML = subOpts;
    document.getElementById('hwActionSubject').innerHTML = subOpts;

    if(uData.role === 'student') {
      nav.innerHTML = '<button onclick="showSection(\'sec-schedule\')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>' +
                      '<button onclick="showSection(\'sec-homework\')">–î–ó</button>' +
                      '<button onclick="showSection(\'sec-marks\')">–ò—Ç–æ–≥–∏</button>';
      loadMyMarks();
    } else {
      nav.innerHTML = '<button onclick="showSection(\'sec-teacher-marks\')">–ñ—É—Ä–Ω–∞–ª</button>' +
                      '<button onclick="showSection(\'sec-teacher-hw\')">–ó–∞–¥–∞—Ç—å –î–ó</button>';
      loadStudentsForTeacher();
    }
    nav.innerHTML += '<button onclick="logout()" style="background:#f87171; color:white;">–í—ã—Ö–æ–¥</button>';
    loadSchedule();
  }
function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  // --- –õ–û–ì–ò–ö–ê –û–¶–ï–ù–û–ö ---
  function loadStudentsForTeacher() {
    db.ref('users').orderByChild('class').equalTo(uData.class).on('value', snap => {
      const list = document.getElementById('studentsList');
      list.innerHTML = '';
      snap.forEach(child => {
        if(child.val().role === 'student') {
          list.innerHTML += '<div class="card flex" style="justify-content:space-between;">' +
            '<span>' + child.val().email + '</span>' +
            '<div class="flex" style="width:180px;">' +
              '<input type="number" id="m_'+child.key+'" min="2" max="5" placeholder="–û—Ü–µ–Ω–∫–∞" style="margin:0">' +
              '<button onclick="sendMark(\''+child.key+'\')" style="width:50px;">–û–ö</button>' +
            '</div></div>';
        }
      });
    });
  }

  function sendMark(sid) {
    const val = document.getElementById('m_'+sid).value;
    const date = document.getElementById('markDate').value;
    const sub = document.getElementById('markSubject').value;
    if(!val || !date) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –æ—Ü–µ–Ω–∫—É!");
    db.ref('marks/' + sid + '/' + sub).push({ val: val, date: date });
    document.getElementById('m_'+sid).value = '';
    alert("–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
  }

  function loadMyMarks() {
    db.ref('marks/' + uData.uid).on('value', snap => {
      const table = document.getElementById('myMarksTable');
      table.innerHTML = '<tr><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∏</th><th>–°—Ä–µ–¥–Ω–∏–π</th></tr>';
      snap.forEach(subSnap => {
        let marks = [], sum = 0;
        subSnap.forEach(m => { 
          marks.push('<span class="mark-badge" title="'+m.val().date+'">'+m.val().val+'</span>');
          sum += Number(m.val().val);
        });
        let avg = (sum / subSnap.numChildren()).toFixed(2);
        table.innerHTML += '<tr><td>'+subSnap.key+'</td><td>'+marks.join('')+'</td><td><b>'+avg+'</b></td></tr>';
      });
    });
  }

  // --- –õ–û–ì–ò–ö–ê –î–ó ---
  function submitHW() {
    const date = document.getElementById('hwActionDate').value;
    const sub = document.getElementById('hwActionSubject').value;
    const text = document.getElementById('hwText').value;
    if(!date || !text) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ —Ç–µ–∫—Å—Ç –î–ó!");
    db.ref('homework/' + uData.class + '/' + date + '/' + sub).set(text);
    alert("–ó–∞–¥–∞–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
    document.getElementById('hwText').value = '';
  }

  function loadHomework() {
    const date = document.getElementById('hwDatePicker').value;
    const res = document.getElementById('hwResults');
    db.ref('homework/' + uData.class + '/' + date).on('value', snap => {
      res.innerHTML = '';
      if(!snap.exists()) res.innerHTML = "–ù–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç.";
      snap.forEach(child => {
        res.innerHTML += '<div class="card"><b>' + child.key + ':</b><p>' + child.val() + '</p></div>';
      });
    });
  }

  // --- –†–ê–°–ü–ò–°–ê–ù–ò–ï ---
  function loadSchedule() {
    const list = document.getElementById('scheduleList');
    list.innerHTML = '';
    let curr = new Date();
    let first = curr.getDate() - curr.getDay() + 1 + (currentWeekOffset * 7);
    let fDate = new Date(curr.setDate(first));
    document.getElementById('weekDates').innerText = fDate.toLocaleDateString() + " ‚Äî " + new Date(curr.setDate(first+4)).toLocaleDateString();
    ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç"].forEach((day, i) => {
      list.innerHTML += '<div class="card" style="margin:5px 0; padding:10px;"><b>'+day+'</b>: '+subjects.slice(0, 5).join(', ')+'</div>';
    });
  }

  function changeWeek(v) { currentWeekOffset += v; loadSchedule(); }
  if(localStorage.getItem('diary-theme')) changeTheme(localStorage.getItem('diary-theme'));
</script>
</body>
</html>

