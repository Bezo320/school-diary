<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EDiary Final Round</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --main: #f97316; --bg: #ffffff; --card: #f3f4f6; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; }
    header { background: var(--main); color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { max-width: 450px; margin: auto; padding: 20px; }
    .card { background: var(--card); padding: 25px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    input, select, button, textarea { 
      width: 100%; padding: 15px; margin: 10px 0; 
      border-radius: 30px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; outline: none;
    }
    button { background: var(--main); color: #fff; border: none; cursor: pointer; font-weight: bold; }
    .nav { display: flex; gap: 10px; margin-bottom: 20px; }
    .nav button { background: #999; flex: 1; padding: 10px; font-size: 14px; }
    .hidden { display: none; }
    .flex { display: flex; gap: 10px; }
    .mark { background: var(--main); color: white; padding: 5px 12px; border-radius: 20px; margin-right: 5px; font-weight: bold; }
  </style>
</head>
<body>

<header>
  <span id="topTitle">Электронный Дневник</span>
  <button onclick="exitApp()" id="exitBtn" class="hidden" style="width:auto; margin:0; padding:8px 15px; background:#e11d48">Выход</button>
</header>

<div class="container">
  <div id="loginBox" class="card">
    <h2 style="text-align:center; margin-top:0">Вход</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Пароль">
    <select id="role">
      <option value="student">Ученик</option>
      <option value="teacher">Учитель</option>
    </select>
    <div class="flex">
      <select id="cN">
        <script>for(var i=1;i<=11;i++)document.write('<option value="'+i+'">'+i+'</option>')</script>
      </select>
      <select id="cL">
        <option value="А">А</option><option value="Б">Б</option><option value="В">В</option><option value="Г">Г</option>
      </select>
    </div>
    <button onclick="doAuth()">ВОЙТИ</button>
  </div>

  <div id="appBox" class="hidden">
    <div class="nav">
      <button onclick="showTab('tab-m')">Оценки</button>
      <button onclick="showTab('tab-h')">ДЗ</button>
    </div>
    <div id="tab-m" class="section">
      <div class="card">
        <div id="t-view" class="hidden">
          <h3>Журнал</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <div id="sList" style="margin-top:15px"></div>
        </div>
        <div id="s-view" class="hidden">
          <h3>Мои оценки</h3>
          <div id="myMarks"></div>
        </div>
      </div>
    </div>
    <div id="tab-h" class="section hidden">
      <div class="card">
        <h3>Домашнее задание</h3>
        <input type="date" id="hDate" onchange="loadHW()">
        <div id="hwContent" style="margin:15px 0"></div>
        <div id="t-hw" class="hidden">
          <hr style="opacity:0.2">
          <select id="hSub"></select>
          <textarea id="hText" placeholder="Что задали?"></textarea>
          <button onclick="saveHW()">Сохранить ДЗ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };
firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.database();
  var u = { uid: "", role: "", class: "", email: "" };
  var subs = ["Математика", "Русский", "Физика", "Химия", "История", "Английский"];

  function doAuth() {
    var e = document.getElementById("email").value;
    var p = document.getElementById("pass").value;
    var r = document.getElementById("role").value;
    var c = document.getElementById("cN").value + document.getElementById("cL").value;
    auth.signInWithEmailAndPassword(e, p).then(function(res) {
      db.ref("users/" + res.user.uid).update({ role: r, class: c, email: e });
    }).catch(function() {
      auth.createUserWithEmailAndPassword(e, p).then(function(res) {
        db.ref("users/" + res.user.uid).set({ role: r, class: c, email: e });
      });
    });
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      db.ref("users/" + user.uid).on("value", function(snap) {
        var data = snap.val();
        if (data) {
          u = data; u.uid = user.uid;
          renderApp();
        }
      });
    }
  });

  function renderApp() {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("appBox").style.display = "block";
    document.getElementById("exitBtn").classList.remove("hidden");
    document.getElementById("topTitle").innerText = u.email + " (" + u.class + ")";
    var opt = "";
    for(var i=0; i<subs.length; i++) opt += "<option value='"+subs[i]+"'>"+subs[i]+"</option>";
    document.getElementById("mSub").innerHTML = opt;
    document.getElementById("hSub").innerHTML = opt;
    if (u.role == "teacher") {
      document.getElementById("t-view").classList.remove("hidden");
      document.getElementById("t-hw").classList.remove("hidden");
      loadClass();
    } else {
      document.getElementById("s-view").classList.remove("hidden");
      loadMy();
    }
  }

  function showTab(id) {
    var s = document.getElementsByClassName("section");
    for(var i=0; i<s.length; i++) s[i].style.display = "none";
    document.getElementById(id).style.display = "block";
  }

  function loadClass() {
    db.ref("users").orderByChild("class").equalTo(u.class).on("value", function(snap) {
      var box = document.getElementById("sList"); box.innerHTML = "";
      snap.forEach(function(child) {
        var s = child.val();
        if (s.role == "student") {
          var d = document.createElement("div");
          d.className = "flex"; d.style.marginBottom = "10px";
          d.innerHTML = "<span style='flex:1'>"+s.email+"</span>" +
            "<input id='in_"+child.key+"' type='number' style='width:60px; margin:0' placeholder='5'>" +
            "<button onclick='addMark(\""+child.key+"\")' style='width:60px; margin:0'>ОК</button>";
          box.appendChild(d);
        }
      });
    });
  }

  function addMark(sid) {
    var v = document.getElementById("in_"+sid).value;
    var d = document.getElementById("mDate").value;
    var s = document.getElementById("mSub").value;
    if (v && d) {
      db.ref("marks/" + sid + "/" + s).push({ v: v, d: d });
      alert("Оценка добавлена");
    } else alert("Укажите дату и оценку");
  }

  function loadMy() {
    db.ref("marks/" + u.uid).on("value", function(snap) {
      var box = document.getElementById("myMarks"); box.innerHTML = "";
      snap.forEach(function(sub) {
        var ms = "";
        sub.forEach(function(m) { ms += "<span class='mark'>"+m.val().v+"</span>"; });
        box.innerHTML += "<p><b>"+sub.key+":</b> "+ms+"</p>";
      });
    });
  }

  function saveHW() {
    var d = document.getElementById("hDate").value;
    var s = document.getElementById("hSub").value;
    var t = document.getElementById("hText").value;
    if (d && t) {
      db.ref("hw/" + u.class + "/" + d + "/" + s).set(t);
      alert("ДЗ сохранено");
    }
  }
function loadHW() {
    var d = document.getElementById("hDate").value;
    db.ref("hw/" + u.class + "/" + d).on("value", function(snap) {
      var box = document.getElementById("hwContent"); box.innerHTML = "";
      snap.forEach(function(c) { box.innerHTML += "<p><b>"+c.key+":</b> "+c.val()+"</p>"; });
    });
  }

  function exitApp() {
    auth.signOut().then(function() { location.reload(); });
  }
</script>
</body>
</html>
