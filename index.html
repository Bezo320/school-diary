<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDiary Premium | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { 
      --main: #f97316; --main-dark: #ea580c;
      --bg: #f8fafc; --card: #ffffff; 
      --text: #1e293b; --gray: #64748b;
      --m5: #22c55e; --m4: #a855f7; --m3: #eab308; --m2: #ef4444;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: var(--main); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
    
    .card { background: var(--card); padding: 25px; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2, h3 { margin-top: 0; color: var(--text); }

    input, select, textarea { 
      width: 100%; padding: 14px 18px; margin: 10px 0; border-radius: 16px; 
      border: 2px solid #e2e8f0; font-size: 16px; transition: 0.3s; box-sizing: border-box;
    }
    input:focus { border-color: var(--main); outline: none; }
    button { 
      width: 100%; padding: 14px; margin-top: 10px; border-radius: 16px; border: none;
      background: var(--main); color: white; font-weight: 700; cursor: pointer; transition: 0.2s;
    }
    button:hover { background: var(--main-dark); transform: translateY(-1px); }

    .nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; }
    .nav button { background: #e2e8f0; color: var(--text); padding: 10px 20px; font-size: 14px; white-space: nowrap; margin: 0; flex: 1; }
    .nav button.active { background: var(--main); color: white; }

    .mark-badge { 
      display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center;
      border-radius: 10px; color: white; font-weight: bold; margin-right: 6px; margin-bottom: 5px;
    }
    .m-5 { background: var(--m5); } .m-4 { background: var(--m4); }
    .m-3 { background: var(--m3); } .m-2 { background: var(--m2); }
    .avg-label { font-size: 0.85em; color: var(--gray); font-weight: 600; margin-left: 5px; }

    .hidden { display: none !important; }
    .flex { display: flex; gap: 10px; align-items: center; }
    #timer-val { font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 10px; }
  </style>
</head>
<body>

<header>
  <div>
    <div id="topTitle" style="font-size: 18px; font-weight: bold;">EDiary Premium</div>
    <div id="timer-box" class="hidden">üïí <span id="timer-val">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
  </div>
  <button onclick="exitApp()" id="exitBtn" class="hidden" style="width:auto; background:#ef4444; margin:0; padding:8px 16px;">–í—ã—Ö–æ–¥</button>
</header>

<div class="container">
  <div id="loginBox" class="card">
    <h2 style="text-align:center">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input id="email" type="email" placeholder="–í–∞—à Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <div class="flex">
      <select id="cN">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
<option value="10">10</option><option value="11">11</option>
      </select>
      <select id="cL">
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option><option value="–ì">–ì</option>
      </select>
      <span style="white-space: nowrap;">–∫–ª–∞—Å—Å</span>
    </div>
    <button onclick="doAuth()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
  </div>

  <div id="appBox" class="hidden">
    <div class="nav">
      <button id="btn-m" onclick="showTab('tab-m', 'btn-m')" class="active">–û—Ü–µ–Ω–∫–∏</button>
      <button id="btn-h" onclick="showTab('tab-h', 'btn-h')">–î–ó</button>
      <button id="btn-s" onclick="showTab('tab-s', 'btn-s')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    </div>

    <div id="tab-m" class="section">
      <div class="card">
        <div id="t-view" class="hidden">
          <h3>–ñ—É—Ä–Ω–∞–ª –∫–ª–∞—Å—Å–∞</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <input type="text" id="mComm" placeholder="–¢–µ–º–∞ —É—Ä–æ–∫–∞">
          <div id="sList" style="margin-top:15px"></div>
        </div>
        <div id="s-view" class="hidden">
          <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
          <div id="myMarks">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>

    <div id="tab-h" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hDate" onchange="loadHW()">
        <div id="hwContent" style="margin:15px 0; line-height: 1.6; color: var(--gray);">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É...</div>
        <div id="t-hw" class="hidden">
          <hr style="opacity:0.1; margin:20px 0">
          <select id="hSub"></select>
          <textarea id="hText" rows="3" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"></textarea>
          <button onclick="saveHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
        </div>
      </div>
    </div>

    <div id="tab-s" class="section hidden">
      <div class="card">
        <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>
        <div id="scheduleBox"></div>
        <div id="t-sch" class="hidden">
          <hr style="opacity:0.1; margin:20px 0">
          <select id="schDay">
            <option value="–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="–í—Ç–æ—Ä–Ω–∏–∫">–í—Ç–æ—Ä–Ω–∏–∫</option>
            <option value="–°—Ä–µ–¥–∞">–°—Ä–µ–¥–∞</option><option value="–ß–µ—Ç–≤–µ—Ä–≥">–ß–µ—Ç–≤–µ—Ä–≥</option><option value="–ü—è—Ç–Ω–∏—Ü–∞">–ü—è—Ç–Ω–∏—Ü–∞</option>
          </select>
          <textarea id="schText" rows="5" placeholder="1. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞&#10;2. –†—É—Å—Å–∫–∏–π —è–∑—ã–∫..."></textarea>
          <button onclick="saveSch()">–û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –∫–æ–Ω—Ñ–∏–≥ (API –∫–ª—é—á –∏ URL)
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  
  let u = { uid: "", role: "", class: "", email: "" };
  const subs = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–§–∏–∑–∏–∫–∞", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "–ë–∏–æ–ª–æ–≥–∏—è", "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞"];

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –≤ –∏–Ω–ø—É—Ç—ã
  window.onload = () => {
    const today = new Date().toISOString().split('T')[0];
    if(document.getElementById("mDate")) document.getElementById("mDate").value = today;
    if(document.getElementById("hDate")) document.getElementById("hDate").value = today;
  };

  function doAuth() {
    const e = document.getElementById("email").value;
    const p = document.getElementById("pass").value;
    const r = document.getElementById("role").value;
    const c = document.getElementById("cN").value + document.getElementById("cL").value;
    
    if(!e || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

    auth.signInWithEmailAndPassword(e, p).then(res => {
db.ref("users/" + res.user.uid).update({ role: r, class: c, email: e });
    }).catch(() => {
      auth.createUserWithEmailAndPassword(e, p).then(res => {
        db.ref("users/" + res.user.uid).set({ role: r, class: c, email: e });
      }).catch(err => alert("–û—à–∏–±–∫–∞: " + err.message));
    });
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      db.ref("users/" + user.uid).on("value", snap => {
        if (snap.val()) {
          u = snap.val(); u.uid = user.uid;
          initApp();
        }
      });
    } else {
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("appBox").classList.add("hidden");
      document.getElementById("exitBtn").classList.add("hidden");
    }
  });

  function initApp() {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("appBox").classList.remove("hidden");
    document.getElementById("exitBtn").classList.remove("hidden");
    document.getElementById("timer-box").classList.remove("hidden");
    document.getElementById("topTitle").innerText = ${u.class} | ${u.role === 'teacher' ? '–£–ß–ò–¢–ï–õ–¨' : '–£–ß–ï–ù–ò–ö'};

    let opt = subs.map(s => <option value="${s}">${s}</option>).join("");
    document.getElementById("mSub").innerHTML = opt;
    document.getElementById("hSub").innerHTML = opt;

    if (u.role === "teacher") {
      document.getElementById("t-view").classList.remove("hidden");
      document.getElementById("t-hw").classList.remove("hidden");
      document.getElementById("t-sch").classList.remove("hidden");
      document.getElementById("s-view").classList.add("hidden");
      loadClass();
    } else {
      document.getElementById("s-view").classList.remove("hidden");
      document.getElementById("t-view").classList.add("hidden");
      document.getElementById("t-hw").classList.add("hidden");
      document.getElementById("t-sch").classList.add("hidden");
      loadMyMarks();
    }
    loadSch();
    loadHW();
    updateTimer();
  }

  function showTab(id, btnId) {
    document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.remove("hidden");
    document.getElementById(btnId).classList.add("active");
  }

  // –û–¶–ï–ù–ö–ò
  function loadClass() {
    db.ref("users").orderByChild("class").equalTo(u.class).on("value", snap => {
      let h = "";
      snap.forEach(c => {
        const userData = c.val();
        if (userData.role === "student") {
          h += <div class="flex" style="margin-bottom:12px; background:#f1f5f9; padding:10px; border-radius:12px">
            <span style="flex:1; font-weight:600; font-size:14px">${userData.email.split('@')[0]}</span>
            <input id="in_${c.key}" type="number" style="width:60px; margin:0; padding:8px" placeholder="5" min="2" max="5">
            <button onclick="addMark('${c.key}')" style="width:50px; margin:0; padding:8px">–û–ö</button>
          </div>;
        }
      });
      document.getElementById("sList").innerHTML = h || "–í —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤";
    });
  }

  function addMark(sid) {
    const v = document.getElementById("in_"+sid).value;
    const d = document.getElementById("mDate").value;
    const s = document.getElementById("mSub").value;
    const n = document.getElementById("mComm").value;
    if (v && d) {
      db.ref("marks/" + sid + "/" + s).push({ v: parseInt(v), d: d, n: n });
      alert("–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
      document.getElementById("in_"+sid).value = "";
    } else alert("–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –æ—Ü–µ–Ω–∫—É!");
  }

  function loadMyMarks() {
    db.ref("marks/" + u.uid).on("value", snap => {
      let h = "";
      if(!snap.exists()) {
          document.getElementById("myMarks").innerHTML = "–û—Ü–µ–Ω–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç";
return;
      }
      snap.forEach(sub => {
        let ms = "", sum = 0, count = 0;
        sub.forEach(m => {
          let mark = m.val();
          let colorClass = mark.v >= 5 ? 'm-5' : (mark.v == 4 ? 'm-4' : (mark.v == 3 ? 'm-3' : 'm-2'));
          ms += <span class="mark-badge ${colorClass}" title="${mark.d} ${mark.n || ''}">${mark.v}</span>;
          sum += mark.v; count++;
        });
        h += <div style="margin-bottom:15px">
          <div style="font-weight:bold; margin-bottom:5px">${sub.key} <span class="avg-label">–°—Ä–µ–¥–Ω–∏–π: ${(sum/count).toFixed(2)}</span></div>
          ${ms}
        </div>;
      });
      document.getElementById("myMarks").innerHTML = h;
    });
  }

  // –î–ó
  function saveHW() {
    const d = document.getElementById("hDate").value;
    const s = document.getElementById("hSub").value;
    const t = document.getElementById("hText").value;
    if (d && t) {
        db.ref("hw/" + u.class + "/" + d + "/" + s).set(t).then(() => {
            alert("–î–ó —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            document.getElementById("hText").value = "";
        });
    } else alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –î–ó –∏ –¥–∞—Ç—É");
  }

  function loadHW() {
    const d = document.getElementById("hDate").value;
    if(!d) return;
    db.ref("hw/" + u.class + "/" + d).on("value", snap => {
      let h = "";
      if(snap.exists()){
        snap.forEach(c => h += <div style="margin-bottom:10px; padding:10px; background:#fff; border-radius:10px; border-left: 4px solid var(--main)"><b>${c.key}:</b><br>${c.val()}</div>);
      } else {
        h = "–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–¥–∞–Ω–æ";
      }
      document.getElementById("hwContent").innerHTML = h;
    });
  }

  // –†–ê–°–ü–ò–°–ê–ù–ò–ï
  function saveSch() {
    const day = document.getElementById("schDay").value;
    const txt = document.getElementById("schText").value;
    if(txt) db.ref("schedules/" + u.class + "/" + day).set(txt).then(() => alert("–û–±–Ω–æ–≤–ª–µ–Ω–æ!"));
  }

  function loadSch() {
    db.ref("schedules/" + u.class).on("value", snap => {
      let h = "";
      if(snap.exists()){
        snap.forEach(d => h += <div style="margin-bottom:15px" class="schedule-day"><b>${d.key}</b><pre style="margin:5px 0; font-family:inherit; color:var(--gray); white-space: pre-wrap;">${d.val()}</pre></div>);
      } else {
        h = "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ";
      }
      document.getElementById("scheduleBox").innerHTML = h;
    });
  }

  // –¢–ê–ô–ú–ï–† –£–†–û–ö–û–í
  function updateTimer() {
    const schedule = [
        {s:"08:30", e:"09:15"}, {s:"09:25", e:"10:10"}, 
        {s:"10:25", e:"11:10"}, {s:"11:25", e:"12:10"}, 
        {s:"12:20", e:"13:05"}, {s:"13:15", e:"14:00"}
    ];
    
    function check() {
      const now = new Date();
      const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
      let status = "–£—Ä–æ–∫–∏ –æ–∫–æ–Ω—á–µ–Ω—ã";
      
      for(let i=0; i<schedule.length; i++) {
        if(time >= schedule[i].s && time <= schedule[i].e) { 
            status = –ò–¥–µ—Ç ${i+1} —É—Ä–æ–∫; break; 
        }
        if(i < schedule.length-1 && time > schedule[i].e && time < schedule[i+1].s) { 
            status = "–ü–µ—Ä–µ–º–µ–Ω–∞"; break; 
        }
      }
      document.getElementById("timer-val").innerText = status;
    }
    check();
    setInterval(check, 30000);
  }

  function exitApp() { 
    auth.signOut().then(() => {
        location.reload();
    }); 
  }
</script>
</body>
</html>
