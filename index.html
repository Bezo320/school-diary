<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDiary Premium</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { 
      --main: #f97316; --main-dark: #ea580c;
      --bg: #f8fafc; --card: #ffffff; 
      --text: #1e293b; --gray: #64748b;
      --m5: #22c55e; --m4: #a855f7; --m3: #eab308; --m2: #ef4444;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: var(--main); color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
    
    .card { background: var(--card); padding: 25px; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    h2, h3 { margin-top: 0; color: var(--text); }

    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
    input, select, textarea { 
      width: 100%; padding: 14px 18px; margin: 10px 0; border-radius: 16px; 
      border: 2px solid #e2e8f0; font-size: 16px; transition: 0.3s; box-sizing: border-box;
    }
    input:focus { border-color: var(--main); outline: none; }
    button { 
      width: 100%; padding: 14px; margin-top: 10px; border-radius: 16px; border: none;
      background: var(--main); color: white; font-weight: 700; cursor: pointer; transition: 0.2s;
    }
    button:hover { background: var(--main-dark); transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .nav button { background: #e2e8f0; color: var(--text); padding: 10px 20px; font-size: 14px; white-space: nowrap; margin: 0; }
    .nav button.active { background: var(--main); color: white; }

    /* –û—Ü–µ–Ω–∫–∏ */
    .mark-badge { 
      display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center;
      border-radius: 10px; color: white; font-weight: bold; margin-right: 6px; margin-bottom: 5px;
    }
    .m-5 { background: var(--m5); } .m-4 { background: var(--m4); }
    .m-3 { background: var(--m3); } .m-2 { background: var(--m2); }
    .avg-label { font-size: 0.85em; color: var(--gray); font-weight: 600; margin-left: 5px; }

    .hidden { display: none !important; }
    .flex { display: flex; gap: 10px; }
    #timer-val { font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 10px; }
  </style>
</head>
<body>

<header>
  <div>
    <div id="topTitle" style="font-size: 18px;">EDiary Premium</div>
    <div id="timer-box" class="hidden">üïí <span id="timer-val">–£—Ä–æ–∫ –∏–¥–µ—Ç</span></div>
  </div>
  <button onclick="exitApp()" id="exitBtn" class="hidden" style="width:auto; background:#ef4444; margin:0; padding:8px 16px;">–í—ã—Ö–æ–¥</button>
</header>

<div class="container">
  <div id="loginBox" class="card">
    <h2 style="text-align:center">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
    <input id="email" type="email" placeholder="–í–∞—à Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <div class="flex">
      <select id="cN">
        <option value="1">1 –∫–ª–∞—Å—Å</option><option value="2">2 –∫–ª–∞—Å—Å</option><option value="3">3 –∫–ª–∞—Å—Å</option>
        <option value="4">4 –∫–ª–∞—Å—Å</option><option value="5">5 –∫–ª–∞—Å—Å</option><option value="6">6 –∫–ª–∞—Å—Å</option>
<option value="7">7 –∫–ª–∞—Å—Å</option><option value="8">8 –∫–ª–∞—Å—Å</option><option value="9">9 –∫–ª–∞—Å—Å</option>
        <option value="10">10 –∫–ª–∞—Å—Å</option><option value="11">11 –∫–ª–∞—Å—Å</option>
      </select>
      <select id="cL">
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option><option value="–ì">–ì</option>
      </select>
    </div>
    <button onclick="doAuth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
  </div>

  <div id="appBox" class="hidden">
    <div class="nav">
      <button id="btn-m" onclick="showTab('tab-m', 'btn-m')" class="active">–û—Ü–µ–Ω–∫–∏</button>
      <button id="btn-h" onclick="showTab('tab-h', 'btn-h')">–î–ó</button>
      <button id="btn-s" onclick="showTab('tab-s', 'btn-s')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    </div>

    <div id="tab-m" class="section">
      <div class="card">
        <div id="t-view" class="hidden">
          <h3>–ñ—É—Ä–Ω–∞–ª –∫–ª–∞—Å—Å–∞</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <input type="text" id="mComm" placeholder="–ó–∞ —á—Ç–æ –æ—Ü–µ–Ω–∫–∞? (—Ç–µ–º–∞)">
          <div id="sList" style="margin-top:15px"></div>
        </div>
        <div id="s-view" class="hidden">
          <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
          <div id="myMarks"></div>
        </div>
      </div>
    </div>

    <div id="tab-h" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hDate" onchange="loadHW()">
        <div id="hwContent" style="margin:15px 0; line-height: 1.6;"></div>
        <div id="t-hw" class="hidden">
          <hr style="opacity:0.1; margin:20px 0">
          <select id="hSub"></select>
          <textarea id="hText" rows="3" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"></textarea>
          <button onclick="saveHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
        </div>
      </div>
    </div>

    <div id="tab-s" class="section hidden">
      <div class="card">
        <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</h3>
        <div id="scheduleBox"></div>
        <div id="t-sch" class="hidden">
          <hr style="opacity:0.1; margin:20px 0">
          <select id="schDay">
            <option value="–ü–Ω">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="–í—Ç">–í—Ç–æ—Ä–Ω–∏–∫</option>
            <option value="–°—Ä">–°—Ä–µ–¥–∞</option><option value="–ß—Ç">–ß–µ—Ç–≤–µ—Ä–≥</option><option value="–ü—Ç">–ü—è—Ç–Ω–∏—Ü–∞</option>
          </select>
          <textarea id="schText" rows="5" placeholder="1. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞&#10;2. –†—É—Å—Å–∫–∏–π..."></textarea>
          <button onclick="saveSch()">–û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // –ö–û–ù–§–ò–ì
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  let u = { uid: "", role: "", class: "", email: "" };
  const subs = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–§–∏–∑–∏–∫–∞", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è"];

  // –í–•–û–î
  function doAuth() {
    const e = document.getElementById("email").value;
    const p = document.getElementById("pass").value;
    const r = document.getElementById("role").value;
    const c = document.getElementById("cN").value + document.getElementById("cL").value;
    
    if(!e || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

    auth.signInWithEmailAndPassword(e, p).then(res => {
      db.ref("users/" + res.user.uid).update({ role: r, class: c, email: e });
    }).catch(() => {
      auth.createUserWithEmailAndPassword(e, p).then(res => {
        db.ref("users/" + res.user.uid).set({ role: r, class: c, email: e });
      }).catch(err => alert("–û—à–∏–±–∫–∞: " + err.message));
    });
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      db.ref("users/" + user.uid).on("value", snap => {
        if (snap.val()) {
          u = snap.val(); u.uid = user.uid;
          initApp();
        }
      });
    }
  });
function initApp() {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("appBox").classList.remove("hidden");
    document.getElementById("exitBtn").classList.remove("hidden");
    document.getElementById("timer-box").classList.remove("hidden");
    document.getElementById("topTitle").innerText = u.class + " | " + u.role.toUpperCase();

    let opt = subs.map(s => <option value="${s}">${s}</option>).join("");
    document.getElementById("mSub").innerHTML = opt;
    document.getElementById("hSub").innerHTML = opt;

    if (u.role === "teacher") {
      document.getElementById("t-view").classList.remove("hidden");
      document.getElementById("t-hw").classList.remove("hidden");
      document.getElementById("t-sch").classList.remove("hidden");
      loadClass();
    } else {
      document.getElementById("s-view").classList.remove("hidden");
      loadMyMarks();
    }
    loadSch();
    updateTimer();
  }

  function showTab(id, btnId) {
    document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.remove("hidden");
    document.getElementById(btnId).classList.add("active");
  }

  // –û–¶–ï–ù–ö–ò
  function loadClass() {
    db.ref("users").orderByChild("class").equalTo(u.class).on("value", snap => {
      let h = "";
      snap.forEach(c => {
        if (c.val().role === "student") {
          h += <div class="flex" style="margin-bottom:12px; background:#f1f5f9; padding:10px; border-radius:12px">
            <span style="flex:1; font-weight:600">${c.val().email.split('@')[0]}</span>
            <input id="in_${c.key}" type="number" style="width:60px; margin:0; padding:8px" placeholder="5">
            <button onclick="addMark('${c.key}')" style="width:50px; margin:0; padding:8px">–û–ö</button>
          </div>;
        }
      });
      document.getElementById("sList").innerHTML = h;
    });
  }

  function addMark(sid) {
    const v = document.getElementById("in_"+sid).value, d = document.getElementById("mDate").value;
    const s = document.getElementById("mSub").value, n = document.getElementById("mComm").value;
    if (v && d) {
      db.ref("marks/" + sid + "/" + s).push({ v: parseInt(v), d: d, n: n });
      alert("–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
      document.getElementById("in_"+sid).value = "";
    } else alert("–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –æ—Ü–µ–Ω–∫—É!");
  }

  function loadMyMarks() {
    db.ref("marks/" + u.uid).on("value", snap => {
      let h = "";
      snap.forEach(sub => {
        let ms = "", sum = 0, count = 0;
        sub.forEach(m => {
          let mark = m.val();
          let color = mark.v >= 5 ? 'm-5' : (mark.v == 4 ? 'm-4' : (mark.v == 3 ? 'm-3' : 'm-2'));
          ms += <span class="mark-badge ${color}" title="${mark.d} ${mark.n||''}">${mark.v}</span>;
          sum += mark.v; count++;
        });
        h += <div style="margin-bottom:15px">
          <div style="font-weight:bold; margin-bottom:5px">${sub.key} <span class="avg-label">–°—Ä–µ–¥–Ω–∏–π: ${(sum/count).toFixed(1)}</span></div>
          ${ms}
        </div>;
      });
      document.getElementById("myMarks").innerHTML = h || "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫";
    });
  }

  // –î–ó
  function saveHW() {
    const d = document.getElementById("hDate").value, s = document.getElementById("hSub").value, t = document.getElementById("hText").value;
    if (d && t) db.ref("hw/" + u.class + "/" + d + "/" + s).set(t).then(() => alert("–î–ó —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"));
  }

  function loadHW() {
    const d = document.getElementById("hDate").value;
    db.ref("hw/" + u.class + "/" + d).on("value", snap => {
      let h = "";
      snap.forEach(c => h += <div style="margin-bottom:10px"><b>${c.key}:</b><br>${c.val()}</div>);
      document.getElementById("hwContent").innerHTML = h || "–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–¥–∞–Ω–æ";
    });
  }
// –†–ê–°–ü–ò–°–ê–ù–ò–ï
  function saveSch() {
    const day = document.getElementById("schDay").value, txt = document.getElementById("schText").value;
    db.ref("schedules/" + u.class + "/" + day).set(txt).then(() => alert("–û–±–Ω–æ–≤–ª–µ–Ω–æ!"));
  }

  function loadSch() {
    db.ref("schedules/" + u.class).on("value", snap => {
      let h = "";
      snap.forEach(d => h += <div style="margin-bottom:15px"><b>${d.key}</b><pre style="margin:5px 0; font-family:inherit; color:var(--gray)">${d.val()}</pre></div>);
      document.getElementById("scheduleBox").innerHTML = h || "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
    });
  }

  // –¢–ê–ô–ú–ï–†
  function updateTimer() {
    const schedule = [{s:"08:30", e:"09:15"}, {s:"09:25", e:"10:10"}, {s:"10:25", e:"11:10"}, {s:"11:25", e:"12:10"}, {s:"12:20", e:"13:05"}];
    setInterval(() => {
      const now = new Date();
      const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
      let status = "–£—Ä–æ–∫–∏ –æ–∫–æ–Ω—á–µ–Ω—ã";
      for(let i=0; i<schedule.length; i++) {
        if(time >= schedule[i].s && time <= schedule[i].e) { status = –ò–¥–µ—Ç ${i+1} —É—Ä–æ–∫; break; }
        if(i < schedule.length-1 && time > schedule[i].e && time < schedule[i+1].s) { status = –ü–µ—Ä–µ–º–µ–Ω–∞; break; }
      }
      document.getElementById("timer-val").innerText = status;
    }, 5000);
  }

  function exitApp() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
