<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>EDiary Final Fix</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --main: #f97316; --bg: #ffffff; --text: #1f2937; --card: #f3f4f6; }
    body.dark { --main: #6366f1; --bg: #111827; --text: #f9fafb; --card: #1f2937; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
    
    header { background: var(--main); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 600px; margin: auto; padding: 20px; }
    
    .card { background: var(--card); padding: 25px; border-radius: 25px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
    
    input, select, button, textarea { 
      width: 100%; padding: 14px 20px; margin: 8px 0; 
      border-radius: 25px; /* –ó–ê–ö–†–£–ì–õ–ï–ù–ò–ï */
      border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; outline: none;
    }
    
    button { background: var(--main); color: #fff; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    
    .nav { display: flex; gap: 10px; margin-bottom: 20px; }
    .nav button { background: #9ca3af; flex: 1; padding: 10px; font-size: 14px; }
    .nav button.active { background: var(--main); }

    .hidden { display: none !important; }
    .flex { display: flex; gap: 10px; }
    .mark-badge { background: var(--main); color: white; padding: 5px 12px; border-radius: 15px; font-weight: bold; margin-right: 5px; }
  </style>
</head>
<body>

<header>
  <span id="uTitle" style="font-weight: bold;">üìò –î–Ω–µ–≤–Ω–∏–∫</span>
  <select id="th" onchange="document.body.className=this.value" style="width:auto; padding: 5px 10px;">
    <option value="">–°–≤–µ—Ç–ª–∞—è</option>
    <option value="dark">–¢–µ–º–Ω–∞—è</option>
  </select>
</header>

<div class="container">
  <div id="authBox" class="card">
    <h2 style="text-align: center; margin-top: 0;">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input id="email" type="email" placeholder="–í–∞—à Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>

    <div class="flex">
      <select id="cNum">
        <option value="">–ö–ª–∞—Å—Å</option>
        <script>for(var i=1; i<=11; i++) document.write('<option value="'+i+'">'+i+'</option>');</script>
      </select>
      <select id="cLit">
        <option value="">–ë—É–∫–≤–∞</option>
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option><option value="–ì">–ì</option>
      </select>
    </div>
    
    <button onclick="handleLogin()" style="margin-top: 15px;">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
  </div>

  <div id="app" class="hidden">
    <div class="nav" id="menu"></div>

    <div id="sec-marks" class="section">
      <div class="card">
        <div id="teachView" class="hidden">
          <h3>–ñ—É—Ä–Ω–∞–ª –∫–ª–∞—Å—Å–∞</h3>
          <div class="flex">
            <input type="date" id="mDate">
            <select id="mSub"></select>
          </div>
          <div id="stList" style="margin-top: 15px;"></div>
        </div>

        <div id="studView" class="hidden">
          <h3>–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
          <div id="myMarks"></div>
        </div>
      </div>
    </div>

    <div id="sec-hw" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
<input type="date" id="hDate" onchange="loadHW()">
        <div id="hwResult" style="margin: 15px 0;"></div>
        
        <div id="teachHW" class="hidden">
          <hr style="opacity: 0.2;">
          <select id="hSub"></select>
          <textarea id="hText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ..." rows="3"></textarea>
          <button onclick="saveHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var config = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };
  firebase.initializeApp(config);
  var auth = firebase.auth();
  var db = firebase.database();
  var u = null;
  var subjects = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π", "–§–∏–∑–∏–∫–∞", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π"];

  function handleLogin() {
    var email = document.getElementById('email').value;
    var pass = document.getElementById('pass').value;
    var role = document.getElementById('role').value;
    var cls = document.getElementById('cNum').value + document.getElementById('cLit').value;

    if (!email  !pass  cls.length < 2) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å!");
      return;
    }

    auth.signInWithEmailAndPassword(email, pass).then(function(res) {
      updateUser(res.user.uid, role, cls, email);
    }).catch(function() {
      auth.createUserWithEmailAndPassword(email, pass).then(function(res) {
        updateUser(res.user.uid, role, cls, email);
      }).catch(function(err) { alert(err.message); });
    });
  }

  function updateUser(uid, r, c, e) {
    db.ref('users/' + uid).set({ role: r, class: c, email: e }).then(function() {
      // –ë–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º! –ü—Ä–æ—Å—Ç–æ –∂–¥–µ–º onAuthStateChanged
    });
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      db.ref('users/' + user.uid).on('value', function(snap) {
        u = snap.val();
        if (u) {
          u.uid = user.uid;
          showApp();
        }
      });
    }
  });

  function showApp() {
    document.getElementById('authBox').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('uTitle').innerText = u.email + " (" + u.class + ")";
    
    var mS = document.getElementById('mSub');
    var hS = document.getElementById('hSub');
    var opt = '';
    for(var i=0; i<subjects.length; i++) opt += '<option value="'+subjects[i]+'">'+subjects[i]+'</option>';
    mS.innerHTML = opt; hS.innerHTML = opt;

    var menu = document.getElementById('menu');
    var html = '<button onclick="tab(\'sec-marks\')">–ñ—É—Ä–Ω–∞–ª</button>' +
               '<button onclick="tab(\'sec-hw\')">–î–ó</button>' +
               '<button onclick="logout()" style="background:#ef4444">–í—ã—Ö–æ–¥</button>';
    menu.innerHTML = html;

    if (u.role == 'teacher') {
      document.getElementById('teachView').classList.remove('hidden');
      document.getElementById('teachHW').classList.remove('hidden');
      loadClass();
    } else {
      document.getElementById('studView').classList.remove('hidden');
      loadMyMarks();
    }
  }

  function logout() {
    auth.signOut().then(function() { location.reload(); });
  }

  function tab(id) {
    var secs = document.getElementsByClassName('section');
    for(var i=0; i<secs.length; i++) secs[i].classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
  }

  function loadClass() {
    db.ref('users').orderByChild('class').equalTo(u.class).on('value', function(snap) {
      var list = document.getElementById('stList');
      list.innerHTML = '';
      snap.forEach(function(child) {
        var s = child.val();
        if (s.role == 'student') {
          var div = document.createElement('div');
div.className = 'flex';
          div.style.marginBottom = '10px';
          div.innerHTML = '<span style="flex:1">'+s.email+'</span>' +
            '<input id="in_'+child.key+'" type="number" placeholder="5" style="width:70px; margin:0">' +
            '<button onclick="saveMark(\''+child.key+'\')" style="width:60px; margin:0">–û–ö</button>';
          list.appendChild(div);
        }
      });
    });
  }

  function saveMark(sid) {
    var val = document.getElementById('in_'+sid).value;
    var date = document.getElementById('mDate').value;
    var sub = document.getElementById('mSub').value;
    if (val && date) {
      db.ref('marks/' + sid + '/' + sub).push({ v: val, d: date });
      alert('–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ!');
    } else alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É!');
  }

  function loadMyMarks() {
    db.ref('marks/' + u.uid).on('value', function(snap) {
      var res = document.getElementById('myMarks');
      res.innerHTML = '';
      snap.forEach(function(sub) {
        var ms = '';
        sub.forEach(function(m) { ms += '<span class="mark-badge">'+m.val().v+'</span>'; });
        res.innerHTML += '<div style="margin-bottom:15px;"><b>'+sub.key+':</b><br>'+ms+'</div>';
      });
    });
  }

  function saveHW() {
    var d = document.getElementById('hDate').value;
    var s = document.getElementById('hSub').value;
    var t = document.getElementById('hText').value;
    if (d && t) {
      db.ref('hw/' + u.class + '/' + d + '/' + s).set(t);
      alert('–î–ó —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
    } else alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –≤–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç!');
  }

  function loadHW() {
    var d = document.getElementById('hDate').value;
    db.ref('hw/' + u.class + '/' + d).on('value', function(snap) {
      var res = document.getElementById('hwResult');
      res.innerHTML = '';
      if (!snap.exists()) res.innerHTML = '–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç.';
      snap.forEach(function(c) {
        res.innerHTML += '<div class="card" style="padding:10px; margin:5px 0;"><b>'+c.key+':</b> '+c.val()+'</div>';
      });
    });
  }
</script>
</body>
</html>


