<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EDiary Final</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --main: #f97316; --bg: #fff; --text: #000; }
    body.dark { --main: #6366f1; --bg: #111; --text: #eee; }
    body.blue { --main: #3b82f6; }
    body.pink { --main: #ec4899; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: var(--main); color: #fff; padding: 15px; display: flex; justify-content: space-between; }
    .container { max-width: 700px; margin: auto; padding: 20px; }
    .card { background: rgba(128,128,128,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ccc; }
    .hidden { display: none; }
    input, select, button, textarea { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
    button { background: var(--main); color: #fff; border: none; cursor: pointer; font-weight: bold; }
    .nav { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav button { background: #888; flex: 1; }
  </style>
</head>
<body>

<header>
  <span id="userTitle">Дневник</span>
  <select id="th" onchange="document.body.className=this.value" style="width:auto">
    <option value="">Оранжевый</option>
    <option value="dark">Темный</option>
    <option value="blue">Синий</option>
    <option value="pink">Розовый</option>
  </select>
</header>

<div class="container">
  <div id="authBox" class="card">
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Пароль">
    <select id="role">
      <option value="student">Ученик</option>
      <option value="teacher">Учитель</option>
    </select>
    <input id="cls" placeholder="Класс (например 10А)">
    <button onclick="login()">Войти</button>
  </div>

  <div id="app" class="hidden">
    <div class="nav" id="menu"></div>

    <div id="s-marks" class="section">
      <div class="card">
        <div id="t-marks" class="hidden">
          <h3>Журнал</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <div id="stList"></div>
        </div>
        <div id="u-marks" class="hidden">
          <h3>Мои оценки</h3>
          <div id="myM"></div>
        </div>
      </div>
    </div>

    <div id="s-hw" class="section hidden">
      <div class="card">
        <h3>Домашнее задание</h3>
        <input type="date" id="hDate" onchange="getHW()">
        <div id="hwShow"></div>
        <div id="t-hw" class="hidden">
          <hr>
          <select id="hSub"></select>
          <textarea id="hText" placeholder="Задание..."></textarea>
          <button onclick="setHW()">Сохранить ДЗ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var config = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };
  firebase.initializeApp(config);
  var auth = firebase.auth();
  var db = firebase.database();
  var userObj = null;
  var subs = ["Математика", "Русский", "Физика", "Химия", "История"];

  function login() {
    var e = document.getElementById('email').value;
    var p = document.getElementById('pass').value;
    var r = document.getElementById('role').value;
    var c = document.getElementById('cls').value;
    auth.signInWithEmailAndPassword(e, p).then(function(res) {
      db.ref('users/' + res.user.uid).update({ role: r, class: c, email: e });
      location.reload();
    }).catch(function() {
      auth.createUserWithEmailAndPassword(e, p).then(function(res) {
        db.ref('users/' + res.user.uid).set({ role: r, class: c, email: e });
        location.reload();
      });
    });
  }
auth.onAuthStateChanged(function(u) {
    if (u) {
      db.ref('users/' + u.uid).once('value', function(snap) {
        userObj = snap.val();
        userObj.uid = u.uid;
        document.getElementById('authBox').style.display = 'none';
        document.getElementById('app').className = '';
        init();
      });
    }
  });

  function init() {
    var mS = document.getElementById('mSub');
    var hS = document.getElementById('hSub');
    var h = '';
    for(var i=0; i<subs.length; i++) h += '<option value="'+subs[i]+'">'+subs[i]+'</option>';
    mS.innerHTML = h; hS.innerHTML = h;

    var menu = document.getElementById('menu');
    var btns = '<button onclick="go(\'s-marks\')">Оценки</button><button onclick="go(\'s-hw\')">ДЗ</button>';
    btns += '<button onclick="auth.signOut().then(function(){location.reload()})" style="background:red">Выход</button>';
    menu.innerHTML = btns;

    if (userObj.role == 'teacher') {
      document.getElementById('t-marks').className = '';
      document.getElementById('t-hw').className = '';
      loadSt();
    } else {
      document.getElementById('u-marks').className = '';
      loadMy();
    }
  }

  function go(id) {
    document.getElementById('s-marks').className = 'section hidden';
    document.getElementById('s-hw').className = 'section hidden';
    document.getElementById(id).className = 'section';
  }

  function loadSt() {
    db.ref('users').orderByChild('class').equalTo(userObj.class).on('value', function(snap) {
      var list = document.getElementById('stList'); list.innerHTML = '';
      snap.forEach(function(c) {
        if (c.val().role == 'student') {
          var d = document.createElement('div');
          d.innerHTML = '<span>'+c.val().email+'</span><input id="in_'+c.key+'" style="width:40px" placeholder="5"><button onclick="addM(\''+c.key+'\')" style="width:40px">OK</button>';
          list.appendChild(d);
        }
      });
    });
  }

  function addM(id) {
    var v = document.getElementById('in_'+id).value;
    var d = document.getElementById('mDate').value;
    var s = document.getElementById('mSub').value;
    if (v && d) {
      db.ref('marks/' + id + '/' + s).push({ v: v, d: d });
      alert('ОК');
    }
  }

  function loadMy() {
    db.ref('marks/' + userObj.uid).on('value', function(snap) {
      var res = document.getElementById('myM'); res.innerHTML = '';
      snap.forEach(function(sSnap) {
        var m = ''; sSnap.forEach(function(mark) { m += mark.val().v + ' '; });
        res.innerHTML += '<p>'+sSnap.key+': '+m+'</p>';
      });
    });
  }

  function setHW() {
    var d = document.getElementById('hDate').value;
    var s = document.getElementById('hSub').value;
    var t = document.getElementById('hText').value;
    db.ref('hw/' + userObj.class + '/' + d + '/' + s).set(t);
    alert('ДЗ сохранено');
  }

  function getHW() {
    var d = document.getElementById('hDate').value;
    db.ref('hw/' + userObj.class + '/' + d).on('value', function(snap) {
      var res = document.getElementById('hwShow'); res.innerHTML = '';
      snap.forEach(function(c) { res.innerHTML += '<p><b>'+c.key+':</b> '+c.val()+'</p>'; });
    });
  }
</script>
</body>
</html>



