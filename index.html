<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDiary Premium | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫</title>
  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    /* –°—Ç–∏–ª–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
    :root { --main: #f97316; --main-dark: #ea580c; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --gray: #64748b; --m5: #22c55e; --m4: #a855f7; --m3: #eab308; --m2: #ef4444; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: var(--main); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
    .card { background: var(--card); padding: 25px; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
    h2, h3 { margin-top: 0; color: var(--text); }
    input, select, textarea { width: 100%; padding: 14px 18px; margin: 10px 0; border-radius: 16px; border: 2px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
    button { width: 100%; padding: 14px; margin-top: 10px; border-radius: 16px; border: none; background: var(--main); color: white; font-weight: 700; cursor: pointer; transition: 0.2s; }
    button:disabled { background: #ccc; }
    .nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; }
    .nav button { background: #e2e8f0; color: var(--text); padding: 10px 20px; flex: 1; margin: 0; }
    .nav button.active { background: var(--main); color: white; }
    .hw-img { width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; border: 1px solid #eee; }
    .mark-badge { display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center; border-radius: 10px; color: white; font-weight: bold; margin-right: 6px; }
    .m-5 { background: var(--m5); } .m-4 { background: var(--m4); } .m-3 { background: var(--m3); } .m-2 { background: var(--m2); }
    .notification-dot { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }
    .hidden { display: none !important; }
    .flex { display: flex; gap: 10px; align-items: center; }
  </style>
</head>
<body>

<header>
  <div>
    <div id="topTitle" style="font-size: 18px; font-weight: bold;">EDiary Premium</div>
    <div id="timer-box" class="hidden">üïí <span id="timer-val">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
  </div>
  <button onclick="exitApp()" id="exitBtn" class="hidden" style="width:auto; background:#ef4444; margin:0; padding:8px 16px;">–í—ã—Ö–æ–¥</button>
</header>

<div class="container">
  <!-- –ë–ª–æ–∫ –≤—Ö–æ–¥–∞ -->
  <div id="loginBox" class="card">
    <h2 style="text-align:center">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <div class="flex">
      <select id="cN">
        <option value="1">1</option><option value="5">5</option><option value="9">9</option><option value="11">11</option>
      </select>
      <select id="cL">
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option>
      </select>
      <span>–∫–ª–∞—Å—Å</span>
    </div>
    <button onclick="doAuth()">–í–û–ô–¢–ò / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    <button style="background:none; color:var(--gray); font-size:12px;" onclick="resetPass()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
  </div>
  
  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Å–∫—Ä—ã—Ç–æ –¥–æ –≤—Ö–æ–¥–∞) -->
  <div id="appBox" class="hidden">
    <div class="nav">
      <button id="btn-m" onclick="showTab('tab-m', 'btn-m')" class="active">–û—Ü–µ–Ω–∫–∏ <span id="notif-mark" class="notification-dot"></span></button>
      <button id="btn-h" onclick="showTab('tab-h', 'btn-h')">–î–ó</button>
      <button id="btn-s" onclick="showTab('tab-s', 'btn-s')">–ì—Ä–∞—Ñ–∏–∫</button>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –û—Ü–µ–Ω–∫–∏ -->
    <div id="tab-m" class="section">
      <div class="card">
        <!-- –í–∏–¥ –¥–ª—è —É—á–∏—Ç–µ–ª—è -->
        <div id="t-view" class="hidden">
          <h3>–ñ—É—Ä–Ω–∞–ª</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <div id="sList"></div>
        </div>
        <!-- –í–∏–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞ -->
        <div id="s-view" class="hidden">
          <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
          <div id="myMarks">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ -->
    <div id="tab-h" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hDate" onchange="loadHW()">
        <div id="hwContent"></div>
        <!-- –ë–ª–æ–∫ –¥–ª—è —É—á–∏—Ç–µ–ª—è (–ø—É–±–ª–∏–∫–∞—Ü–∏—è –î–ó) -->
        <div id="t-hw" class="hidden">
          <hr>
          <select id="hSub"></select>
          <textarea id="hText" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è..."></textarea>
          <input type="file" id="hFile" accept="image/*">
          <button id="hwBtn" onclick="saveHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
    <div id="tab-s" class="section hidden">
      <div class="card" id="scheduleBox"></div>
    </div>
  </div>
</div>

<script>

import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

const firebaseConfig = {
  apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
  authDomain: "school-diary-3798a.firebaseapp.com",
  databaseURL: "https://school-diary-3798a-default-rtdb.firebaseio.com",
  projectId: "school-diary-3798a",
  storageBucket: "school-diary-3798a.firebasestorage.app",
  messagingSenderId: "332652695618",
  appId: "1:332652695618:web:4100f4cffb026271a5dddb",
  measurementId: "G-NP908WXSTM"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  
  // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î)
  let u = { uid: "", role: "", class: "" };
  const subs = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–§–∏–∑–∏–∫–∞", "–ò—Å—Ç–æ—Ä–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "–•–∏–º–∏—è", "–ë–∏–æ–ª–æ–≥–∏—è"];

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
  window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById("mDate")) document.getElementById("mDate").value = today;
    if (document.getElementById("hDate")) document.getElementById("hDate").value = today;
  };

  // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  function doAuth() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("pass").value;
    const role = document.getElementById("role").value;
    const classNum = document.getElementById("cN").value + document.getElementById("cL").value;
    
    if (!email || !pass) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å!");
      return;
    }

    auth.signInWithEmailAndPassword(email, pass)
      .then((userCredential) => {
        return db.ref("users/" + userCredential.user.uid).update({
          role: role,
          class: classNum,
          email: email
        });
      })
      .catch((error) => {
        if (error.code === 'auth/user-not-found') {
          auth.createUserWithEmailAndPassword(email, pass)
            .then((userCredential) => {
              return db.ref("users/" + userCredential.user.uid).set({
                role: role,
                class: classNum,
                email: email
              });
            })
            .catch((err) => {
              alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + err.message);
            });
        } else {
          alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
        }
      });
  }

  function resetPass() {
    const email = document.getElementById("email").value;
    if (!email) {
      alert("–í–≤–µ–¥–∏—Ç–µ email –≤ –ø–æ–ª–µ!");
      return;
    }
    auth.sendPasswordResetEmail(email)
      .then(() => alert("–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ " + email))
      .catch((err) => alert(err.message));
  }

  auth.onAuthStateChanged((user) => {
    if (user) {
      db.ref("users/" + user.uid).on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
          u = data;
          u.uid = user.uid;
          initApp();
        } else {
          db.ref("users/" + user.uid).set({
            role: "student",
            class: "5–ê",
            email: user.email
          });
        }
      });
    } else {
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("appBox").classList.add("hidden");
      document.getElementById("exitBtn").classList.add("hidden");
    }
  });

  function initApp() {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("appBox").classList.remove("hidden");
    document.getElementById("exitBtn").classList.remove("hidden");
    document.getElementById("timer-box").classList.remove("hidden");
    
    let roleName = (u.role === "teacher") ? "–£–ß–ò–¢–ï–õ–¨" : "–£–ß–ï–ù–ò–ö";
    document.getElementById("topTitle").innerText = (u.class || "?") + " | " + roleName;
    
    let options = "";
    for (let i = 0; i < subs.length; i++) {
      options += '<option value="' + subs[i] + '">' + subs[i] + '</option>';
    }
    if (document.getElementById("mSub")) document.getElementById("mSub").innerHTML = options;
    if (document.getElementById("hSub")) document.getElementById("hSub").innerHTML = options;

    if (u.role === "teacher") {
      document.getElementById("t-view").classList.remove("hidden");
      document.getElementById("t-hw").classList.remove("hidden");
      document.getElementById("s-view").classList.add("hidden");
      loadClass();
    } else {
      document.getElementById("s-view").classList.remove("hidden");
      document.getElementById("t-view").classList.add("hidden");
      loadMyMarks();
      checkNewMarks();
    }

    loadHW();
    loadSch();
    updateTimer();
  }

  function showTab(tabId, btnId) {
    document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(tabId).classList.remove("hidden");
    document.getElementById(btnId).classList.add("active");
    if (tabId === 'tab-m' && document.getElementById("notif-mark")) {
      document.getElementById("notif-mark").style.display = "none";
    }
  }

  function loadHW() {
    const date = document.getElementById("hDate").value;
    if (!date) return;
    db.ref("homework/" + u.class + "/" + date).on("value", (snapshot) => {
      let html = "";
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          const data = child.val();
          let imgTag = "";
          if (data.img) {
            imgTag = '<img src="' + data.img + '" class="hw-img" onclick="window.open(\'' + data.img + '\')">';
          }
          html += '<div style="padding:10px; border-bottom:1px solid #eee"><b>' + child.key + ':</b> ' + (data.text || "") + imgTag + '</div>';
        });
      } else {
        html = "–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç";
      }
      document.getElementById("hwContent").innerHTML = html;
    });
  }

  function saveHW() {
    const btn = document.getElementById("hwBtn");
    const date = document.getElementById("hDate").value;
    const subject = document.getElementById("hSub").value;
    const text = document.getElementById("hText").value;
    const file = document.getElementById("hFile").files[0];

    if (!date || !text) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è!");
      return;
    }

    btn.disabled = true;
    btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

    function publish(imgUrl = "") {
      db.ref("homework/" + u.class + "/" + date + "/" + subject).set({
        text: text,
        img: imgUrl,
        teacher: u.uid,
        timestamp: Date.now()
      }).then(() => {
        alert("–î–ó –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!");
        btn.disabled = false;
        btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó";
        document.getElementById("hText").value = "";
        document.getElementById("hFile").value = "";
      }).catch((err) => {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message);
        btn.disabled = false;
        btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó";
      });
    }

    if (file) {
      const storageRef = storage.ref("homework/" + u.class + "/" + Date.now() + "_" + file.name);
      storageRef.put(file).then(() => storageRef.getDownloadURL()).then((url) => publish(url)).catch((err) => {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: " + err.message);
        btn.disabled = false;
        btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó";
      });
    } else {
      publish();
    }
  }

  function loadClass() {
    db.ref("users").orderByChild("class").equalTo(u.class).on("value", (snapshot) => {
      let html = "";
      snapshot.forEach((child) => {
        const userData = child.val();
        if (userData.role === "student") {
          const studentName = userData.email ? userData.email.split('@')[0] : "–£—á–µ–Ω–∏–∫";
          html += '<div class="flex" style="margin-top:10px">' +
                  '<span style="flex:1">' + studentName + '</span>' +
                  '<input id="in_' + child.key + '" type="number" min="2" max="5" style="width:70px; margin:0" placeholder="–û—Ü–µ–Ω–∫–∞">' +
                  '<button onclick="addMark(\'' + child.key + '\')" style="width:40px; margin:0">OK</button>' +
                  '</div>';
        }
      });
      document.getElementById("sList").innerHTML = html || "–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤";
    });
  }

  function addMark(studentId) {
    const markInput = document.getElementById("in_" + studentId);
    const value = markInput.value;
    const date = document.getElementById("mDate").value;
    const subject = document.getElementById("mSub").value;

    if (!value || !date || !subject) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–æ—Ü–µ–Ω–∫–∞, –¥–∞—Ç–∞, –ø—Ä–µ–¥–º–µ—Ç)");
      return;
    }

    const mark = parseInt(value);
    if (isNaN(mark) || mark < 2 || mark > 5) {
      alert("–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 2 –¥–æ 5");
      return;
    }

    db.ref("marks/" + studentId + "/" + subject).push({
      v: mark,
      d: date,
      teacher: u.uid,
      timestamp: Date.now()
    }).then(() => {
      markInput.value = "";
      alert("–û—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
    }).catch((err) => {
      alert("–û—à–∏–±–∫–∞: " + err.message);
    });
  }

  function loadMyMarks() {
    db.ref("marks/" + u.uid).on("value", (snapshot) => {
      let html = "";
      if (snapshot.exists()) {
        snapshot.forEach((subjectSnap) => {
          let marksHtml = "";
          subjectSnap.forEach((markSnap) => {
            const val = markSnap.val().v;
            let cls = 'm-2';
            if (val >= 5) cls = 'm-5';
            else if (val === 4) cls = 'm-4';
            else if (val === 3) cls = 'm-3';
            marksHtml += '<span class="mark-badge ' + cls + '">' + val + '</span>';
          });
          html += '<div><b>' + subjectSnap.key + ':</b><br>' + marksHtml + '</div><hr style="opacity:0.1">';
        });
      } else {
        html = "–û—Ü–µ–Ω–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç";
      }
      document.getElementById("myMarks").innerHTML = html;
    });
  }

  function checkNewMarks() {
    db.ref("marks/" + u.uid).limitToLast(1).on("child_added", () => {
      const tabM = document.getElementById("tab-m");
      const notif = document.getElementById("notif-mark");
      if (tabM && notif && tabM.classList.contains("hidden")) {
        notif.style.display = "block";
      }
    });
  }

  function loadSch() {
    db.ref("schedules/" + u.class).on("value", (snapshot) => {
      let html = "<h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>";
      if (snapshot.exists()) {
        snapshot.forEach((daySnap) => {
          html += "<b>" + daySnap.key + ":</b> " + daySnap.val() + "<br>";
        });
      } else {
        html += "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      }
      document.getElementById("scheduleBox").innerHTML = html;
    });
  }

  function updateTimer() {
    setInterval(() => {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const totalMinutes = hours * 60 + minutes;
      
      let status = "–£—Ä–æ–∫–∏ –æ–∫–æ–Ω—á–µ–Ω—ã";
      if (totalMinutes >= 480 && totalMinutes < 840) {
        status = "–ò–¥—É—Ç —É—Ä–æ–∫–∏ (1 —Å–º–µ–Ω–∞)";
      } else if (totalMinutes >= 840 && totalMinutes < 1020) {
        status = "–ò–¥—É—Ç —É—Ä–æ–∫–∏ (2 —Å–º–µ–Ω–∞)";
      }
      
      const timerEl = document.getElementById("timer-val");
      if (timerEl) {
        timerEl.innerText = status + " (" + hours + ":" + (minutes < 10 ? '0' + minutes : minutes) + ")";
      }
    }, 1000);
  }

  function exitApp() {
    auth.signOut().then(() => location.reload()).catch((err) => console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", err));
  }
</script>
</body>
</html>

