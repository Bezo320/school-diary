<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>EDiary Ultra Safe</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --main: #f97316; --bg: #ffffff; --text: #1f2937; --card: #fef2f2; }
    body.theme-dark { --main: #6366f1; --bg: #111827; --text: #f9fafb; --card: #1f2937; }
    body { margin:0; font-family: sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--main); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #ddd; }
    .hidden { display: none; }
    .flex { display: flex; gap: 10px; align-items: center; }
    input, select, button, textarea { padding: 10px; margin: 5px 0; width: 100%; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; background: #fff; color: #000; }
    button { background: var(--main); color: white; border: none; cursor: pointer; font-weight: bold; }
    .nav { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav button { background: #eee; color: #000; font-size: 14px; flex: 1; }
    .mark-item { border-bottom: 1px solid #ddd; padding: 5px 0; display: flex; justify-content: space-between; }
  </style>
</head>
<body>

<header>
  <span id="userTitle">Мой Дневник</span>
  <select id="themePicker" onchange="document.body.className=this.value" style="width:auto">
    <option value="">Светлая</option>
    <option value="theme-dark">Темная</option>
  </select>
</header>

<div class="container">
  <div id="authBlock" class="card">
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Пароль">
    <select id="role">
      <option value="student">Я Ученик</option>
      <option value="teacher">Я Учитель</option>
    </select>
    <div class="flex">
        <input id="cNum" placeholder="Класс (1-11)">
        <input id="cLit" placeholder="Буква (А-Г)">
    </div>
    <button onclick="handleAuth()">Войти</button>
  </div>

  <div id="app" class="hidden">
    <div class="nav" id="mainNav"></div>

    <div id="sec-marks" class="section">
      <div class="card">
        <div id="teacherWork" class="hidden">
          <h3>Журнал оценок</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <div id="sList"></div>
        </div>
        <div id="studentWork" class="hidden">
          <h3>Мои оценки</h3>
          <div id="myMarks"></div>
        </div>
      </div>
    </div>

    <div id="sec-hw" class="section hidden">
      <div class="card">
        <h3>Домашнее задание</h3>
        <input type="date" id="hDate" onchange="loadHW()">
        <div id="hwResult"></div>
        
        <div id="teacherHW" class="hidden">
          <hr>
          <h3>Задать ДЗ</h3>
          <select id="hSub"></select>
          <textarea id="hText" placeholder="Введите задание..."></textarea>
          <button onclick="saveHW()">Сохранить задание</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Твой конфиг
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let u = { role: '', class: '', email: '', uid: '' };
  const subs = ["Математика", "Русский", "Физика", "Химия", "История", "География"];
function handleAuth() {
    const e = document.getElementById('email').value;
    const p = document.getElementById('pass').value;
    const r = document.getElementById('role').value;
    const c = document.getElementById('cNum').value + document.getElementById('cLit').value;

    auth.signInWithEmailAndPassword(e, p).then(function(res) {
      db.ref('users/' + res.user.uid).update({ role: r, class: c, email: e });
      location.reload();
    }).catch(function() {
      auth.createUserWithEmailAndPassword(e, p).then(function(res) {
        db.ref('users/' + res.user.uid).set({ role: r, class: c, email: e });
        location.reload();
      });
    });
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      db.ref('users/' + user.uid).once('value', function(snap) {
        u = snap.val();
        u.uid = user.uid;
        document.getElementById('authBlock').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userTitle').innerText = u.email;
        start();
      });
    }
  });

  function start() {
    const nav = document.getElementById('mainNav');
    const mSub = document.getElementById('mSub');
    const hSub = document.getElementById('hSub');
    
    let options = '';
    for(let i = 0; i < subs.length; i++) {
        options += '<option value="'+subs[i]+'">'+subs[i]+'</option>';
    }
    mSub.innerHTML = options; 
    hSub.innerHTML = options;

    let navHtml = '<button onclick="tab(\'sec-marks\')">Оценки</button>';
    navHtml += '<button onclick="tab(\'sec-hw\')">ДЗ</button>';
    navHtml += '<button onclick="logout()" style="background:#ff4444; color:#fff">Выход</button>';
    nav.innerHTML = navHtml;

    if (u.role === 'teacher') {
      document.getElementById('teacherWork').classList.remove('hidden');
      document.getElementById('teacherHW').classList.remove('hidden');
      loadStudents();
    } else {
      document.getElementById('studentWork').classList.remove('hidden');
      loadMyMarks();
    }
  }

  function logout() {
    auth.signOut().then(function() {
        location.reload();
    });
  }

  function tab(id) {
    const sections = document.querySelectorAll('.section');
    for(let i = 0; i < sections.length; i++) {
        sections[i].classList.add('hidden');
    }
    document.getElementById(id).classList.remove('hidden');
  }

  function loadStudents() {
    db.ref('users').orderByChild('class').equalTo(u.class).on('value', function(snap) {
      const list = document.getElementById('sList');
      list.innerHTML = '';
      snap.forEach(function(child) {
        const student = child.val();
        if (student.role === 'student') {
          const div = document.createElement('div');
          div.className = 'flex';
          div.innerHTML = '<span>'+student.email+'</span>' +
            '<input type="number" id="in_'+child.key+'" style="width:60px" placeholder="5">' +
            '<button onclick="addM(\''+child.key+'\')" style="width:50px">OK</button>';
          list.appendChild(div);
        }
      });
    });
  }

  function addM(sid) {
    const val = document.getElementById('in_'+sid).value;
    const date = document.getElementById('mDate').value;
    const sub = document.getElementById('mSub').value;
    if (val && date) {
      db.ref('marks/' + sid + '/' + sub).push({ v: val, d: date });
      alert('Оценка добавлена');
    } else {
      alert('Выбери дату и оценку');
    }
  }

  function loadMyMarks() {
    db.ref('marks/' + u.uid).on('value', function(snap) {
      const res = document.getElementById('myMarks');
      res.innerHTML = '';
      snap.forEach(function(sSnap) {
        let m = '';
        sSnap.forEach(function(mark) { m += mark.val().v + ' '; });
        res.innerHTML += '<div class="mark-item"><b>'+sSnap.key+':</b> <span>'+m+'</span></div>';
      });
    });
  }
function saveHW() {
    const d = document.getElementById('hDate').value;
    const s = document.getElementById('hSub').value;
    const t = document.getElementById('hText').value;
    if (d && t) {
        db.ref('hw/' + u.class + '/' + d + '/' + s).set(t);
        alert('ДЗ сохранено');
    } else {
        alert('Выбери дату и введи текст');
    }
  }

  function loadHW() {
    const d = document.getElementById('hDate').value;
    db.ref('hw/' + u.class + '/' + d).on('value', function(snap) {
      const res = document.getElementById('hwResult');
      res.innerHTML = '';
      snap.forEach(function(c) {
        res.innerHTML += '<div class="card"><b>'+c.key+':</b> <p>'+c.val()+'</p></div>';
      });
    });
  }
</script>
</body>
</html>


