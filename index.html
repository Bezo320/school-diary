<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>EDiary Final Work</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --main: #f97316; --bg: #ffffff; --text: #1f2937; --card: #f3f4f6; }
    body.dark { --main: #6366f1; --bg: #111827; --text: #f9fafb; --card: #1f2937; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
    
    header { background: var(--main); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .container { max-width: 500px; margin: auto; padding: 20px; }
    
    /* –ó–ê–ö–†–£–ì–õ–ï–ù–ù–´–ï –ö–ê–†–¢–û–ß–ö–ò –ò –ü–û–õ–Ø */
    .card { background: var(--card); padding: 25px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    
    input, select, button, textarea { 
      width: 100%; padding: 12px 20px; margin: 8px 0; 
      border-radius: 25px; /* –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –ó–ê–ö–†–£–ì–õ–ï–ù–ò–ï */
      border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; outline: none;
    }
    
    button { background: var(--main); color: #fff; border: none; cursor: pointer; font-weight: bold; }
    .nav { display: flex; gap: 8px; margin-bottom: 15px; }
    .nav button { background: #9ca3af; flex: 1; padding: 10px; font-size: 14px; }
    
    .hidden { display: none; }
    .flex { display: flex; gap: 10px; }
  </style>
</head>
<body>

<header>
  <span id="title">üìò –ú–æ–π –î–Ω–µ–≤–Ω–∏–∫</span>
  <select id="th" onchange="document.body.className=this.value" style="width:auto; padding: 5px;">
    <option value="">–°–≤–µ—Ç–ª–∞—è</option>
    <option value="dark">–¢–µ–º–Ω–∞—è</option>
  </select>
</header>

<div class="container">
  <div id="authScreen" class="card">
    <h2 style="text-align: center;">–í—Ö–æ–¥</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>

    <div class="flex">
      <select id="cNum">
        <option value="">–ö–ª–∞—Å—Å</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option><option value="11">11</option>
      </select>
      <select id="cLit">
        <option value="">–ë—É–∫–≤–∞</option>
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option><option value="–ì">–ì</option>
      </select>
    </div>
    
    <button onclick="startAuth()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>

  <div id="mainApp" class="hidden">
    <div class="nav" id="menu"></div>

    <div id="page-marks" class="section">
      <div class="card">
        <div id="t-view" class="hidden">
          <h3>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h3>
          <input type="date" id="markDate">
          <select id="markSub"></select>
          <div id="studentsList" style="margin-top:15px"></div>
        </div>
        <div id="s-view" class="hidden">
          <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
          <div id="myMarksList"></div>
        </div>
      </div>
    </div>

    <div id="page-hw" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hwDate" onchange="loadHW()">
        <div id="hwContent" style="margin:15px 0"></div>
        <div id="t-hw-box" class="hidden">
          <hr>
          <select id="hwSub"></select>
          <textarea id="hwText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ..." rows="3"></textarea>
          <button onclick="saveHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.database();
  var currentUser = null;
  var subjects = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π", "–§–∏–∑–∏–∫–∞", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è"];

  function startAuth() {
    var e = document.getElementById('email').value;
    var p = document.getElementById('pass').value;
    var r = document.getElementById('role').value;
    var c = document.getElementById('cNum').value + document.getElementById('cLit').value;

    if (e.length < 3  p.length < 3  c.length < 2) {
        alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
        return;
    }

    auth.signInWithEmailAndPassword(e, p).then(function(res) {
        saveAndGo(res.user.uid, r, c, e);
    }).catch(function() {
        auth.createUserWithEmailAndPassword(e, p).then(function(res) {
            saveAndGo(res.user.uid, r, c, e);
        });
    });
  }

  function saveAndGo(uid, r, c, e) {
    db.ref('users/' + uid).set({ role: r, class: c, email: e }).then(function() {
        // –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, onAuthStateChanged —Å–∞–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç —ç–∫—Ä–∞–Ω
    });
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      db.ref('users/' + user.uid).on('value', function(snap) {
        currentUser = snap.val();
        if (currentUser) {
          currentUser.uid = user.uid;
          initApp();
        }
      });
    }
  });

  function initApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('title').innerText = currentUser.email + " (" + currentUser.class + ")";

    var options = '';
    for(var i=0; i<subjects.length; i++) options += '<option value="'+subjects[i]+'">'+subjects[i]+'</option>';
    document.getElementById('markSub').innerHTML = options;
    document.getElementById('hwSub').innerHTML = options;

    var menu = document.getElementById('menu');
    menu.innerHTML = '<button onclick="showPage(\'page-marks\')">–ñ—É—Ä–Ω–∞–ª</button>' +
                     '<button onclick="showPage(\'page-hw\')">–î–ó</button>' +
                     '<button onclick="exit()" style="background:#ef4444">–í—ã—Ö–æ–¥</button>';

    if (currentUser.role == 'teacher') {
      document.getElementById('t-view').style.display = 'block';
      document.getElementById('t-hw-box').style.display = 'block';
      loadClass();
    } else {
      document.getElementById('s-view').style.display = 'block';
      loadMyMarks();
    }
  }

  function exit() {
    auth.signOut().then(function() { location.reload(); });
  }

  function showPage(id) {
    var p = document.getElementsByClassName('section');
    for(var i=0; i<p.length; i++) p[i].style.display = 'none';
    document.getElementById(id).style.display = 'block';
  }

  function loadClass() {
    db.ref('users').orderByChild('class').equalTo(currentUser.class).on('value', function(snap) {
      var list = document.getElementById('studentsList');
      list.innerHTML = '';
      snap.forEach(function(child) {
        var s = child.val();
        if (s.role == 'student') {
          var row = document.createElement('div');
          row.className = 'flex';
          row.style.marginBottom = '8px';
          row.innerHTML = '<span style="flex:1">'+s.email+'</span>' +
            '<input id="m_'+child.key+'" type="number" style="width:60px; margin:0" placeholder="5">' +
            '<button onclick="setMark(\''+child.key+'\')" style="width:60px; margin:0">–û–ö</button>';
          list.appendChild(row);
        }
      });
    });
  }

  function setMark(sid) {
    var v = document.getElementById('m_'+sid).value;
var d = document.getElementById('markDate').value;
    var s = document.getElementById('markSub').value;
    if (v && d) {
      db.ref('marks/' + sid + '/' + s).push({ v: v, d: d });
      alert('–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    } else alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É!');
  }

  function loadMyMarks() {
    db.ref('marks/' + currentUser.uid).on('value', function(snap) {
      var res = document.getElementById('myMarksList');
      res.innerHTML = '';
      snap.forEach(function(sub) {
        var ms = '';
        sub.forEach(function(m) { ms += '<span style="background:var(--main); color:white; padding:4px 10px; border-radius:15px; margin-right:5px; font-weight:bold">'+m.val().v+'</span>'; });
        res.innerHTML += '<div style="margin-bottom:15px"><b>'+sub.key+':</b><br>'+ms+'</div>';
      });
    });
  }

  function saveHW() {
    var d = document.getElementById('hwDate').value;
    var s = document.getElementById('hwSub').value;
    var t = document.getElementById('hwText').value;
    if (d && t) {
      db.ref('hw/' + currentUser.class + '/' + d + '/' + s).set(t);
      alert('–î–ó –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
    } else alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!');
  }

  function loadHW() {
    var d = document.getElementById('hwDate').value;
    db.ref('hw/' + currentUser.class + '/' + d).on('value', function(snap) {
      var res = document.getElementById('hwContent');
      res.innerHTML = '';
      if (!snap.exists()) res.innerHTML = '–ù–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç.';
      snap.forEach(function(c) {
        res.innerHTML += '<div class="card" style="padding:10px; margin:5px 0;"><b>'+c.key+':</b> '+c.val()+'</div>';
      });
    });
  }
</script>
</body>
</html>
