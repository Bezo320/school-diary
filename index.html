<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ - –°–∏—Å—Ç–µ–º–∞</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    :root { --bg:#fff7ed; --card:#ffffff; --primary:#f97316; --text:#1f2937; }
    body.dark { --bg:#1f2937; --card:#111827; --primary:#fb923c; --text:#f9fafb; }
    body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--text); transition:.3s; }
    header { background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
    .container { max-width:1000px; margin:auto; padding:20px; }
    .card { background:var(--card); padding:20px; border-radius:14px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .nav-tabs { display:flex; gap:10px; margin-bottom:20px; overflow-x:auto; }
    .nav-tabs button { flex:1; white-space:nowrap; background:#e5e7eb; color:black; border:none; padding:10px; cursor:pointer; border-radius:8px; }
    .nav-tabs button.active { background:var(--primary); color:white; }
    input, select, button { padding:12px; margin:5px 0; width:100%; border-radius:8px; border:1px solid #ddd; box-sizing:border-box; }
    button { background:var(--primary); color:white; border:none; cursor:pointer; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    .hidden { display:none; }
    .mark-badge { display:inline-block; padding:5px 10px; border-radius:5px; font-weight:bold; background:#f97316; color:white; }
  </style>
</head>
<body>

<header>
  <span>üìò –î–Ω–µ–≤–Ω–∏–∫: <span id="userDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</span></span>
  <button onclick="toggleTheme()" style="width:auto; padding:5px 10px;">üåó</button>
</header>

<div class="container">
  <div id="loginPage" class="card">
    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <input id="className" placeholder="–ö–ª–∞—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10–ê)">
    <button onclick="loginUser()">–í–æ–π—Ç–∏</button>
  </div>

  <div id="app" class="hidden">
    <div class="nav-tabs">
      <button onclick="showTab('tab-marks')" id="btn-marks" class="active">–û—Ü–µ–Ω–∫–∏</button>
      <button onclick="showTab('tab-schedule')" id="btn-schedule">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
      <button onclick="showTab('tab-quarter')" id="btn-quarter">–ò—Ç–æ–≥–∏</button>
      <button onclick="logout()" style="background:#ef4444; color:white;">–í—ã—Ö–æ–¥</button>
    </div>

    <div id="tab-marks" class="tab-content">
      <div id="teacherPanel" class="card hidden">
        <h3>–ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è: –ü–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h3>
        <select id="subjectSelect"></select> <input id="topicInput" placeholder="–¢–µ–º–∞ —É—Ä–æ–∫–∞">
        <input id="markInput" type="number" min="2" max="5" placeholder="–û—Ü–µ–Ω–∫–∞">
        <button onclick="addMark()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
      </div>
      
      <div class="card">
        <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
        <div id="marksList"></div>
      </div>
    </div>

    <div id="tab-schedule" class="tab-content hidden">
      <div class="card">
        <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</h3>
        <div id="scheduleContent"></div>
      </div>
    </div>

    <div id="tab-quarter" class="tab-content hidden">
      <div class="card">
        <h3>–°—Ä–µ–¥–Ω–∏–µ –±–∞–ª–ª—ã</h3>
        <table>
          <thead><tr><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–°—Ä–µ–¥–Ω–∏–π</th><th>–ò—Ç–æ–≥</th></tr></thead>
          <tbody id="quarterTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
  // –¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  const schedule = {
    '–ü–Ω': ['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–§–∏–∑–∏–∫–∞'],
    '–í—Ç': ['–ò—Å—Ç–æ—Ä–∏—è', '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π', '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞'],
    '–°—Ä': ['–ê–ª–≥–µ–±—Ä–∞', '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞'],
    '–ß—Ç': ['–•–∏–º–∏—è', '–ë–∏–æ–ª–æ–≥–∏—è', '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è'],
    '–ü—Ç': ['–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', '–û–ë–ñ', '–ì–µ–æ–º–µ—Ç—Ä–∏—è']
  };

  let currentUser = null;
  let userRole = localStorage.getItem('role') || 'student';
  let userClass = localStorage.getItem('class') || '';

  // –¢–µ–º—ã
  function toggleTheme() {
    document.body.classList.toggle('dark');
    localStorage.setItem('dark', document.body.classList.contains('dark'));
  }
  if(localStorage.getItem('dark')==='true') document.body.classList.add('dark');

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.remove('hidden');
    document.getElementById('btn-' + tabId.replace('tab-', '')).classList.add('active');
  }

  // –í—Ö–æ–¥
  function loginUser() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    userRole = document.getElementById('role').value;
    userClass = document.getElementById('className').value;
    
    localStorage.setItem('role', userRole);
    localStorage.setItem('class', userClass);

    auth.signInWithEmailAndPassword(email, pass)
      .catch(() => auth.createUserWithEmailAndPassword(email, pass));
  }

  function logout() {
    auth.signOut();
    localStorage.clear();
    location.reload();
  }

  // –°–ª–µ–¥–∏–º –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('userDisplay').textContent = user.email + ' [' + userClass + ']';
      
      if (userRole === 'teacher') {
        document.getElementById('teacherPanel').classList.remove('hidden');
        fillSubjectSelect();
      }
      
      initApp();
    } else {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
    }
  });

  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è —É—á–∏—Ç–µ–ª—è –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  function fillSubjectSelect() {
    const select = document.getElementById('subjectSelect');
    const allSubjects = new Set();
    for (let day in schedule) {
      schedule[day].forEach(s => allSubjects.add(s));
    }
    
    select.innerHTML = '';
    allSubjects.forEach(s => {
      select.innerHTML += '<option value="' + s + '">' + s + '</option>';
    });
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
  function addMark() {
    const subject = document.getElementById('subjectSelect').value;
    const topic = document.getElementById('topicInput').value;
    const mark = document.getElementById('markInput').value;

    if(!topic || !mark) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∏ –æ—Ü–µ–Ω–∫—É!');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–ø–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
    db.ref('marks/' + userClass).push({
      subject: subject,
      topic: topic,
      mark: Number(mark),
      date: new Date().toLocaleDateString(),
      student: currentUser.email // –ß—Ç–æ–±—ã –∑–Ω–∞—Ç—å, —á—å—è –æ—Ü–µ–Ω–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    });

    document.getElementById('topicInput').value = '';
    document.getElementById('markInput').value = '';
    alert('–û—Ü–µ–Ω–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  }
// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
  function initApp() {
    // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    const schDiv = document.getElementById('scheduleContent');
    schDiv.innerHTML = '';
    for (let day in schedule) {
      schDiv.innerHTML += '<h4>' + day + '</h4><p>' + schedule[day].join(', ') + '</p>';
    }

    // 2. –°–ª—É—à–∞—Ç–µ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–∂–∏–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫)
    db.ref('marks/' + userClass).on('value', snap => {
      const marksList = document.getElementById('marksList');
      const quarterTable = document.getElementById('quarterTable');
      marksList.innerHTML = '';
      quarterTable.innerHTML = '';
      
      let allMarks = [];
      snap.forEach(child => { allMarks.push(child.val()); });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ —Å–≤–µ—Ä—Ö—É
      allMarks.slice().reverse().forEach(data => {
        marksList.innerHTML += '<div style="border-bottom:1px solid #ddd; padding:10px 0;">' +
          '<b>' + data.date + '</b> | ' + data.subject + ': <span class="mark-badge">' + data.mark + '</span><br>' +
          '<small>–¢–µ–º–∞: ' + data.topic + '</small></div>';
      });

      // –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
      const stats = {};
      allMarks.forEach(m => {
        if (!stats[m.subject]) stats[m.subject] = { sum: 0, count: 0 };
        stats[m.subject].sum += m.mark;
        stats[m.subject].count++;
      });

      for (let sub in stats) {
        let avg = (stats[sub].sum / stats[sub].count).toFixed(2);
        quarterTable.innerHTML += '<tr><td>' + sub + '</td><td>' + avg + '</td><td><b>' + Math.round(avg) + '</b></td></tr>';
      }
    });
  }
</script>
</body>
</html>
