<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>EDiary Pro</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã */
    :root { --main: #f97316; --bg: #ffffff; --text: #1f2937; --card: #fef2f2; }
    body.theme-blue { --main: #3b82f6; --card: #eff6ff; }
    body.theme-purple { --main: #8b5cf6; --card: #f5f3ff; }
    body.theme-pink { --main: #ec4899; --card: #fdf2f8; }

    body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--main); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
    
    .nav-menu { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .nav-menu button { background: #eee; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; white-space: nowrap; }
    .nav-menu button.active { background: var(--main); color: white; }

    input, select, button { padding: 12px; margin: 5px 0; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    button.btn-main { background: var(--main); color: white; border: none; font-weight: bold; cursor: pointer; }
    
    .hw-item { border-left: 4px solid var(--main); padding-left: 15px; margin: 10px 0; background: white; padding: 10px; border-radius: 5px; }
    .mark-badge { background: var(--main); color: white; padding: 4px 10px; border-radius: 5px; font-weight: bold; }
    .hidden { display: none; }
    .flex { display: flex; gap: 10px; }
  </style>
</head>
<body class="theme-orange">

<header>
  <span id="userTitle">üìò –ú–æ–π –î–Ω–µ–≤–Ω–∏–∫</span>
  <select id="themePicker" onchange="changeTheme(this.value)" style="width: auto; padding: 5px;">
    <option value="theme-orange">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
    <option value="theme-blue">–°–∏–Ω–∏–π</option>
    <option value="theme-purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
    <option value="theme-pink">–†–æ–∑–æ–≤—ã–π</option>
  </select>
</header>

<div class="container">
  <div id="authBlock" class="card">
    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <input id="userClass" placeholder="–í–∞—à –∫–ª–∞—Å—Å (–Ω–∞–ø—Ä. 10–ê)">
    <button class="btn-main" onclick="handleAuth()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <div id="app" class="hidden">
    <div class="nav-menu" id="mainNav">
      </div>

    <div id="sec-schedule" class="section">
      <div class="card">
        <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–µ–ª–∏</h3>
        <div class="flex">
            <button onclick="changeWeek(-1)">‚¨ÖÔ∏è –ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è</button>
            <button onclick="changeWeek(1)">–°–ª–µ–¥. –Ω–µ–¥–µ–ª—è ‚û°Ô∏è</button>
        </div>
        <div id="weekDates" style="margin: 10px 0; font-weight: bold; text-align: center;"></div>
        <div id="scheduleList"></div>
      </div>
    </div>

    <div id="sec-homework" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
        <input type="date" id="hwDatePicker" onchange="loadHomework()">
        <div id="hwResults"></div>
      </div>
    </div>

    <div id="sec-marks" class="section hidden">
      <div class="card">
        <h3>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h3>
        <table width="100%">
          <thead><tr><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∏</th><th>–ò—Ç–æ–≥</th></tr></thead>
          <tbody id="marksTable"></tbody>
        </table>
      </div>
    </div>
<div id="sec-teacher" class="section hidden">
      <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –î–ó –∏–ª–∏ –û—Ü–µ–Ω–∫—É</h3>
        <label>–î–∞—Ç–∞:</label>
        <input type="date" id="actionDate">
        <label>–ü—Ä–µ–¥–º–µ—Ç:</label>
        <select id="actionSubject"></select>
        
        <div style="background: #eee; padding: 10px; border-radius: 10px; margin-top: 10px;">
          <h4>–î–µ–π—Å—Ç–≤–∏–µ:</h4>
          <button onclick="setMode('hw')">–ó–∞–¥–∞—Ç—å –î–ó</button>
          <button onclick="setMode('mark')">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
          
          <div id="inputGroup" class="hidden" style="margin-top: 10px;">
            <input id="inputValue" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è –∏–ª–∏ –æ—Ü–µ–Ω–∫–∞">
            <button class="btn-main" onclick="submitAction()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Firebase Config (–¢–≤–æ–π)
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let role = 'student';
  let myClass = '';
  let currentWeekOffset = 0;
  let actionType = ''; // 'hw' –∏–ª–∏ 'mark'

  const subjects = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "–§–∏–∑–∏–∫–∞", "–•–∏–º–∏—è", "–ò—Å—Ç–æ—Ä–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π"];

  function changeTheme(theme) {
    document.body.className = theme;
    localStorage.setItem('diary-theme', theme);
  }

  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  function handleAuth() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    role = document.getElementById('role').value;
    myClass = document.getElementById('userClass').value;

    if(!myClass) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–ª–∞—Å—Å!");

    auth.signInWithEmailAndPassword(email, pass).catch(() => {
      auth.createUserWithEmailAndPassword(email, pass);
    });
  }

  auth.onAuthStateChanged(user => {
    if(user) {
      document.getElementById('authBlock').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('userTitle').textContent = "–î–Ω–µ–≤–Ω–∏–∫: " + myClass;
      buildNav();
      fillTeacherSelect();
      loadSchedule();
      loadMarks();
    }
  });

  function buildNav() {
    const nav = document.getElementById('mainNav');
    let html = '<button onclick="showSection(\'sec-schedule\')" class="active">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>' +
               '<button onclick="showSection(\'sec-homework\')">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>' +
               '<button onclick="showSection(\'sec-marks\')">–ò—Ç–æ–≥–∏</button>';
    if(role === 'teacher') html += '<button onclick="showSection(\'sec-teacher\')" style="background:#4ade80">–£—á–∏—Ç–µ–ª—å—Å–∫–∞—è</button>';
    html += '<button onclick="location.reload()" style="background:#f87171">–í—ã—Ö–æ–¥</button>';
    nav.innerHTML = html;
  }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –Ω–µ–¥–µ–ª—è–º–∏
  function changeWeek(dir) {
    currentWeekOffset += dir;
    loadSchedule();
  }

  function loadSchedule() {
    const list = document.getElementById('scheduleList');
    const datesInfo = document.getElementById('weekDates');
    list.innerHTML = '';
    
    let curr = new Date();
    let first = curr.getDate() - curr.getDay() + 1 + (currentWeekOffset * 7);
    let firstDay = new Date(curr.setDate(first));
    let lastDay = new Date(curr.setDate(first + 4));

    datesInfo.innerText = firstDay.toLocaleDateString() + " ‚Äî " + lastDay.toLocaleDateString();

    const days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç"];
days.forEach((day, idx) => {
        let d = new Date(firstDay);
        d.setDate(firstDay.getDate() + idx);
        let dateStr = d.toLocaleDateString();
        list.innerHTML += '<div class="hw-item"><b>' + day + ' (' + dateStr + ')</b><br>' + subjects.slice(0, 5).join(', ') + '</div>';
    });
  }

  // –£—á–∏—Ç–µ–ª—å—Å–∫–∞—è –ª–æ–≥–∏–∫–∞
  function fillTeacherSelect() {
    const sel = document.getElementById('actionSubject');
    sel.innerHTML = subjects.map(s => '<option value="'+s+'">'+s+'</option>').join('');
  }

  function setMode(mode) {
    actionType = mode;
    document.getElementById('inputGroup').classList.remove('hidden');
    document.getElementById('inputValue').placeholder = mode === 'hw' ? "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –î–ó" : "–û—Ü–µ–Ω–∫–∞ (2-5)";
  }

  function submitAction() {
    const date = document.getElementById('actionDate').value;
    const sub = document.getElementById('actionSubject').value;
    const val = document.getElementById('inputValue').value;

    if(!date || !val) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ!");

    if(actionType === 'hw') {
      db.ref('homework/' + myClass + '/' + date + '/' + sub).set(val);
    } else {
      db.ref('marks/' + myClass + '/' + sub).push({ val: val, date: date });
    }
    alert("–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –î–ó –¥–ª—è —É—á–µ–Ω–∏–∫–∞
  function loadHomework() {
    const date = document.getElementById('hwDatePicker').value;
    const results = document.getElementById('hwResults');
    results.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

    db.ref('homework/' + myClass + '/' + date).on('value', snap => {
      results.innerHTML = '';
      if(!snap.exists()) results.innerHTML = '<p>–ù–∞ —ç—Ç—É –¥–∞—Ç—É –î–ó –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      snap.forEach(child => {
        results.innerHTML += '<div class="hw-item"><b>' + child.key + '</b><br>' + child.val() + '</div>';
      });
    });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ò—Ç–æ–≥–æ–≤ –∏ –û—Ü–µ–Ω–æ–∫ –ø–æ –¥–∞—Ç–∞–º
  function loadMarks() {
    db.ref('marks/' + myClass).on('value', snap => {
      const tbody = document.getElementById('marksTable');
      tbody.innerHTML = '';
      
      snap.forEach(subSnap => {
        let markList = [];
        let sum = 0;
        subSnap.forEach(m => {
          markList.push('<span title="' + m.val().date + '" class="mark-badge">' + m.val().val + '</span>');
          sum += Number(m.val().val);
        });
        
        let avg = (sum / subSnap.numChildren()).toFixed(2);
        tbody.innerHTML += '<tr><td>'+subSnap.key+'</td><td>'+markList.join(' ')+'</td><td><b>'+Math.round(avg)+'</b></td></tr>';
      });
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
  if(localStorage.getItem('diary-theme')) changeTheme(localStorage.getItem('diary-theme'));
</script>
</body>
</html>
