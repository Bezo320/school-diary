<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDiary Premium | –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    :root { 
      --main: #f97316; --main-dark: #ea580c;
      --bg: #f8fafc; --card: #ffffff; 
      --text: #1e293b; --gray: #64748b;
      --m5: #22c55e; --m4: #a855f7; --m3: #eab308; --m2: #ef4444;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    header { background: var(--main); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
    .card { background: var(--card); padding: 25px; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
    h2, h3 { margin-top: 0; color: var(--text); }
    input, select, textarea { width: 100%; padding: 14px 18px; margin: 10px 0; border-radius: 16px; border: 2px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
    button { width: 100%; padding: 14px; margin-top: 10px; border-radius: 16px; border: none; background: var(--main); color: white; font-weight: 700; cursor: pointer; transition: 0.2s; }
    button:disabled { background: #ccc; }
    .nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; }
    .nav button { background: #e2e8f0; color: var(--text); padding: 10px 20px; flex: 1; margin: 0; }
    .nav button.active { background: var(--main); color: white; }
    .hw-img { width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; border: 1px solid #eee; }
    .mark-badge { display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center; border-radius: 10px; color: white; font-weight: bold; margin-right: 6px; }
    .m-5 { background: var(--m5); } .m-4 { background: var(--m4); } .m-3 { background: var(--m3); } .m-2 { background: var(--m2); }
    .notification-dot { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }
    .hidden { display: none !important; }
    .flex { display: flex; gap: 10px; align-items: center; }
  </style>
</head>
<body>

<header>
  <div>
    <div id="topTitle" style="font-size: 18px; font-weight: bold;">EDiary Premium</div>
    <div id="timer-box" class="hidden">üïí <span id="timer-val">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
  </div>
  <button onclick="exitApp()" id="exitBtn" class="hidden" style="width:auto; background:#ef4444; margin:0; padding:8px 16px;">–í—ã—Ö–æ–¥</button>
</header>

<div class="container">
  <div id="loginBox" class="card">
    <h2 style="text-align:center">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <select id="role">
      <option value="student">–Ø –£—á–µ–Ω–∏–∫</option>
      <option value="teacher">–Ø –£—á–∏—Ç–µ–ª—å</option>
    </select>
    <div class="flex">
      <select id="cN">
        <option value="1">1</option><option value="5">5</option><option value="9">9</option><option value="11">11</option>
      </select>
      <select id="cL">
        <option value="–ê">–ê</option><option value="–ë">–ë</option><option value="–í">–í</option>
      </select>
      <span>–∫–ª–∞—Å—Å</span>
    </div>
    <button onclick="doAuth()">–í–û–ô–¢–ò / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    <button style="background:none; color:var(--gray); font-size:12px;" onclick="resetPass()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
  </div>
<div id="appBox" class="hidden">
    <div class="nav">
      <button id="btn-m" onclick="showTab('tab-m', 'btn-m')" class="active">–û—Ü–µ–Ω–∫–∏ <span id="notif-mark" class="notification-dot"></span></button>
      <button id="btn-h" onclick="showTab('tab-h', 'btn-h')">–î–ó</button>
      <button id="btn-s" onclick="showTab('tab-s', 'btn-s')">–ì—Ä–∞—Ñ–∏–∫</button>
    </div>

    <div id="tab-m" class="section">
      <div class="card">
        <div id="t-view" class="hidden">
          <h3>–ñ—É—Ä–Ω–∞–ª</h3>
          <input type="date" id="mDate">
          <select id="mSub"></select>
          <div id="sList"></div>
        </div>
        <div id="s-view" class="hidden">
          <h3>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
          <div id="myMarks">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>

    <div id="tab-h" class="section hidden">
      <div class="card">
        <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
        <input type="date" id="hDate" onchange="loadHW()">
        <div id="hwContent"></div>
        <div id="t-hw" class="hidden">
          <hr>
          <select id="hSub"></select>
          <textarea id="hText" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è..."></textarea>
          <input type="file" id="hFile" accept="image/*">
          <button id="hwBtn" onclick="saveHW()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó</button>
        </div>
      </div>
    </div>

    <div id="tab-s" class="section hidden">
      <div class="card" id="scheduleBox"></div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCEo8QxfX8faFjUaQNwNlTXbvws7LgXAEs",
    authDomain: "school-diary-3798a.firebaseapp.com",
    databaseURL: "https://school-diary-3798a.firebaseapp.com",
    projectId: "school-diary-3798a",
    storageBucket: "school-diary-3798a.appspot.com"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  
  let u = { uid: "", role: "", class: "" };
  const subs = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–§–∏–∑–∏–∫–∞", "–ò—Å—Ç–æ—Ä–∏—è", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "–•–∏–º–∏—è", "–ë–∏–æ–ª–æ–≥–∏—è"];

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
  window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    if(document.getElementById("mDate")) document.getElementById("mDate").value = today;
    if(document.getElementById("hDate")) document.getElementById("hDate").value = today;
  };

  function doAuth() {
    const e = document.getElementById("email").value;
    const p = document.getElementById("pass").value;
    const r = document.getElementById("role").value;
    const c = document.getElementById("cN").value + document.getElementById("cL").value;
    
    if(!e || !p) {
        alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
        return;
    }

    auth.signInWithEmailAndPassword(e, p).then(function(res) {
      db.ref("users/" + res.user.uid).update({ role: r, class: c, email: e });
    }).catch(function() {
      auth.createUserWithEmailAndPassword(e, p).then(function(res) {
        db.ref("users/" + res.user.uid).set({ role: r, class: c, email: e });
      }).catch(function(err) {
        alert("–û—à–∏–±–∫–∞: " + err.message);
      });
    });
  }

  function resetPass() { 
    const e = document.getElementById("email").value;
    if(!e) {
        alert("–í–≤–µ–¥–∏ Email!");
        return;
    }
    auth.sendPasswordResetEmail(e).then(function() {
        alert("–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞ –ø–æ—á—Ç–µ!");
    }).catch(function(err) {
        alert(err.message);
    });
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      db.ref("users/" + user.uid).on("value", function(snap) {
        const data = snap.val();
        if(data) {
          u = data;
          u.uid = user.uid;
          initApp();
        }
      });
    } else {
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("appBox").classList.add("hidden");
      document.getElementById("exitBtn").classList.add("hidden");
    }
  });
function initApp() {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("appBox").classList.remove("hidden");
    document.getElementById("exitBtn").classList.remove("hidden");
    document.getElementById("timer-box").classList.remove("hidden");
    
    let roleName = "–£–ß–ï–ù–ò–ö";
    if (u.role === "teacher") roleName = "–£–ß–ò–¢–ï–õ–¨";
    document.getElementById("topTitle").innerText = u.class + " | " + roleName;
    
    let opt = "";
    for(let i = 0; i < subs.length; i++) {
        opt += '<option value="' + subs[i] + '">' + subs[i] + '</option>';
    }
    
    document.getElementById("mSub").innerHTML = opt;
    document.getElementById("hSub").innerHTML = opt;

    if (u.role === "teacher") {
      document.getElementById("t-view").classList.remove("hidden");
      document.getElementById("t-hw").classList.remove("hidden");
      document.getElementById("s-view").classList.add("hidden");
      loadClass();
    } else {
      document.getElementById("s-view").classList.remove("hidden");
      document.getElementById("t-view").classList.add("hidden");
      loadMyMarks();
      checkNewMarks();
    }
    loadHW();
    loadSch();
    updateTimer();
  }

  function showTab(id, btnId) {
    const sections = document.querySelectorAll(".section");
    for(let i=0; i < sections.length; i++) sections[i].classList.add("hidden");
    
    const btns = document.querySelectorAll(".nav button");
    for(let i=0; i < btns.length; i++) btns[i].classList.remove("active");
    
    document.getElementById(id).classList.remove("hidden");
    document.getElementById(btnId).classList.add("active");
    if(id === 'tab-m') document.getElementById("notif-mark").style.display = "none";
  }

  function saveHW() {
    const btn = document.getElementById("hwBtn");
    const d = document.getElementById("hDate").value;
    const s = document.getElementById("hSub").value;
    const t = document.getElementById("hText").value;
    const file = document.getElementById("hFile").files[0];
    
    if(!d || !t) {
        alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞—Ç—É –∏ —Ç–µ–∫—Å—Ç!");
        return;
    }
    
    btn.disabled = true; 
    btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    
    function publish(imgUrl) {
      db.ref("hw/" + u.class + "/" + d + "/" + s).set({ text: t, img: imgUrl }).then(function() {
        alert("–ì–æ—Ç–æ–≤–æ!");
        btn.disabled = false; 
        btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –î–ó";
        document.getElementById("hText").value = ""; 
        document.getElementById("hFile").value = "";
      });
    }

    if(file) {
      const ref = storage.ref("hw/" + u.class + "/" + Date.now() + "_" + file.name);
      ref.put(file).then(function() {
          ref.getDownloadURL().then(function(url) {
              publish(url);
          });
      });
    } else {
        publish("");
    }
  }

  function loadHW() {
    const d = document.getElementById("hDate").value;
    if(!d) return;
    db.ref("hw/" + u.class + "/" + d).on("value", function(snap) {
      let h = "";
      if(snap.exists()) {
        snap.forEach(function(c) {
          const data = c.val();
          let imgTag = "";
          if(data.img) {
              imgTag = '<img src="' + data.img + '" class="hw-img" onclick="window.open(\'' + data.img + '\')">';
          }
          h += '<div style="padding:10px; border-bottom:1px solid #eee"><b>' + c.key + ':</b> ' + data.text + imgTag + '</div>';
        });
      } else {
          h = "–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç";
      }
      document.getElementById("hwContent").innerHTML = h;
    });
  }

  function loadClass() {
    db.ref("users").orderByChild("class").equalTo(u.class).on("value", function(snap) {
      let h = "";
      snap.forEach(function(c) {
        if(c.val().role === "student") {
          const emailName = c.val().email.split('@')[0];
h += '<div class="flex" style="margin-top:10px"><span style="flex:1">' + emailName + '</span>';
          h += '<input id="in_' + c.key + '" type="number" style="width:50px; margin:0" placeholder="5">';
          h += '<button onclick="addMark(\'' + c.key + '\')" style="width:40px; margin:0">OK</button></div>';
        }
      });
      document.getElementById("sList").innerHTML = h || "–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤";
    });
  }

  function addMark(sid) {
    const v = document.getElementById("in_"+sid).value;
    const d = document.getElementById("mDate").value;
    const s = document.getElementById("mSub").value;
    if(v && d) db.ref("marks/" + sid + "/" + s).push({ v: parseInt(v), d: d });
  }

  function loadMyMarks() {
    db.ref("marks/" + u.uid).on("value", function(snap) {
      let h = "";
      snap.forEach(function(sub) {
        let ms = "";
        sub.forEach(function(m) {
          const val = m.val().v;
          let cls = 'm-2';
          if(val >= 5) cls = 'm-5';
          else if(val == 4) cls = 'm-4';
          else if(val == 3) cls = 'm-3';
          ms += '<span class="mark-badge ' + cls + '">' + val + '</span>';
        });
        h += '<div><b>' + sub.key + ':</b><br>' + ms + '</div><hr style="opacity:0.1">';
      });
      document.getElementById("myMarks").innerHTML = h || "–û—Ü–µ–Ω–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç";
    });
  }

  function checkNewMarks() {
    db.ref("marks/" + u.uid).limitToLast(1).on("child_added", function() {
       if(document.getElementById("tab-m").classList.contains("hidden")) {
           document.getElementById("notif-mark").style.display = "block";
       }
    });
  }

  function loadSch() {
    db.ref("schedules/" + u.class).on("value", function(snap) {
      let h = "<h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>";
      if(snap.exists()) {
          snap.forEach(function(d) {
              h += "<b>" + d.key + "</b><pre>" + d.val() + "</pre>";
          });
      } else {
          h += "–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      }
      document.getElementById("scheduleBox").innerHTML = h;
    });
  }

  function updateTimer() {
    setInterval(function() {
      const now = new Date();
      const t = now.getHours() * 60 + now.getMinutes();
      let status = "–£—Ä–æ–∫–∏ –æ–∫–æ–Ω—á–µ–Ω—ã";
      if(t < 840) status = "–ò–¥—É—Ç —É—Ä–æ–∫–∏";
      if(document.getElementById("timer-val")) {
          document.getElementById("timer-val").innerText = status;
      }
    }, 1000);
  }

  function exitApp() { 
      auth.signOut().then(function() {
          location.reload(); 
      });
  }
</script>
</body>
</html>
